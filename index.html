<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#0f172a">
    <title>NutriSync AI | 177-Module HealthOS</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://js.stripe.com/v3/"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap');
        
        * { font-family: 'Inter', sans-serif; -webkit-tap-highlight-color: transparent; }
        
        body { background: #020617; color: #e2e8f0; overflow-x: hidden; }
        
        .glass {
            background: rgba(15, 23, 42, 0.7);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(51, 65, 85, 0.5);
        }
        
        .input-field {
            background: rgba(30, 41, 59, 0.8);
            border: 1px solid rgba(71, 85, 105, 0.8);
            color: white;
            transition: all 0.2s;
            width: 100%;
            padding: 14px 16px;
            border-radius: 12px;
            font-size: 16px;
        }
        
        .input-field:focus {
            border-color: #06b6d4;
            box-shadow: 0 0 0 3px rgba(6, 182, 212, 0.1);
            outline: none;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #0891b2, #2563eb);
            color: white;
            font-weight: 700;
            padding: 16px 24px;
            border-radius: 12px;
            border: none;
            cursor: pointer;
            width: 100%;
            font-size: 16px;
            transition: all 0.2s;
            box-shadow: 0 4px 20px rgba(6, 182, 212, 0.3);
        }
        
        .btn-primary:hover { transform: translateY(-2px); box-shadow: 0 6px 30px rgba(6, 182, 212, 0.4); }
        .btn-primary:active { transform: scale(0.98); }
        
        .btn-stripe {
            background: linear-gradient(135deg, #635bff, #8b5cf6);
            color: white;
            font-weight: 700;
            padding: 16px 24px;
            border-radius: 12px;
            border: none;
            cursor: pointer;
            width: 100%;
            font-size: 16px;
            transition: all 0.2s;
            box-shadow: 0 4px 20px rgba(99, 91, 255, 0.3);
        }
        
        .btn-stripe:hover { transform: translateY(-2px); box-shadow: 0 6px 30px rgba(99, 91, 255, 0.4); }
        
        .btn-gold {
            background: linear-gradient(135deg, #f59e0b, #d97706);
            color: white;
            font-weight: 700;
            padding: 16px 24px;
            border-radius: 12px;
            border: none;
            cursor: pointer;
            width: 100%;
            font-size: 16px;
            transition: all 0.2s;
            box-shadow: 0 4px 20px rgba(245, 158, 11, 0.3);
        }
        
        .page { display: none; min-height: 100vh; padding-bottom: 100px; }
        .page.active { display: block; animation: fadeIn 0.3s ease; }
        
        @keyframes fadeIn { from { opacity: 0; transform: translateX(10px); } to { opacity: 1; } }
        
        .tool-btn {
            background: rgba(30, 41, 59, 0.6);
            border: 1px solid rgba(71, 85, 105, 0.3);
            transition: all 0.2s;
            position: relative;
            overflow: hidden;
            cursor: pointer;
            padding: 16px 8px;
            border-radius: 12px;
            text-align: center;
            height: 100px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        
        .tool-btn:hover {
            background: rgba(51, 65, 85, 0.8);
            border-color: rgba(6, 182, 212, 0.5);
            transform: translateY(-2px);
        }
        
        .subscription-badge {
            background: linear-gradient(135deg, #10b981, #059669);
            color: white;
            font-size: 10px;
            font-weight: 800;
            padding: 4px 8px;
            border-radius: 12px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            display: inline-flex;
            align-items: center;
            gap: 4px;
        }
        
        .locked-overlay {
            position: absolute;
            inset: 0;
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10;
            backdrop-filter: blur(4px);
        }
        
        .pricing-card {
            background: linear-gradient(135deg, rgba(30, 41, 59, 0.9), rgba(15, 23, 42, 0.95));
            border: 2px solid rgba(99, 91, 255, 0.3);
            border-radius: 20px;
            padding: 32px;
            position: relative;
            overflow: hidden;
        }
        
        .pricing-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, #635bff, #8b5cf6);
        }
        
        .access-code-box {
            background: linear-gradient(135deg, rgba(245, 158, 11, 0.1), rgba(217, 119, 6, 0.05));
            border: 2px dashed rgba(245, 158, 11, 0.4);
            border-radius: 16px;
            padding: 24px;
            text-align: center;
        }
        
        .grid-177 {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
        }
        
        @media (min-width: 640px) {
            .grid-177 { grid-template-columns: repeat(4, 1fr); }
        }
        
        .chat-message {
            max-width: 85%;
            padding: 12px 16px;
            border-radius: 16px;
            margin-bottom: 12px;
            line-height: 1.5;
        }
        
        .chat-user {
            background: rgba(6, 182, 212, 0.2);
            border: 1px solid rgba(6, 182, 212, 0.3);
            margin-left: auto;
            border-bottom-right-radius: 4px;
            color: white;
        }
        
        .chat-ai {
            background: rgba(30, 41, 59, 0.9);
            border: 1px solid rgba(71, 85, 105, 0.5);
            margin-right: auto;
            border-bottom-left-radius: 4px;
            color: #e2e8f0;
        }
        
        .result-box {
            background: rgba(6, 182, 212, 0.1);
            border: 1px solid rgba(6, 182, 212, 0.3);
            border-radius: 12px;
            padding: 20px;
            margin-top: 16px;
            text-align: center;
        }
        
        .metric-value {
            font-size: 36px;
            font-weight: 800;
            color: #06b6d4;
        }
        
        .hidden { display: none !important; }
    </style>
</head>
<body class="bg-slate-950">

    <!-- AUTH / SUBSCRIPTION OVERLAY -->
    <div id="authOverlay" class="fixed inset-0 z-[300] bg-slate-950 overflow-y-auto">
        
        <!-- Landing Page -->
        <div id="landingPage" class="min-h-screen flex flex-col items-center justify-center p-6">
            <div class="w-full max-w-md space-y-8">
                
                <!-- Logo -->
                <div class="text-center">
                    <div class="w-24 h-24 mx-auto mb-6 rounded-2xl bg-gradient-to-br from-cyan-500 to-blue-600 flex items-center justify-center text-4xl shadow-2xl shadow-cyan-500/30">
                        <i class="fas fa-dna text-white"></i>
                    </div>
                    <h1 class="text-4xl font-bold mb-2 bg-gradient-to-r from-cyan-400 to-blue-500 bg-clip-text text-transparent">NutriSync AI</h1>
                    <p class="text-slate-400 text-lg">177 World-First Health Modules</p>
                </div>

                <!-- Email Signup Form -->
                <div class="glass rounded-2xl p-6 border border-slate-700 space-y-4" id="emailForm">
                    <h2 class="text-xl font-bold text-center mb-4">Create Your Account</h2>
                    <input type="email" id="signupEmail" placeholder="Enter your email" class="input-field">
                    <input type="password" id="signupPassword" placeholder="Create password" class="input-field">
                    <button onclick="createAccount()" class="btn-primary">
                        <i class="fas fa-envelope mr-2"></i>Continue with Email
                    </button>
                    
                    <div class="relative my-6">
                        <div class="absolute inset-0 flex items-center">
                            <div class="w-full border-t border-slate-700"></div>
                        </div>
                        <div class="relative flex justify-center text-sm">
                            <span class="px-2 bg-slate-900 text-slate-400">or</span>
                        </div>
                    </div>
                    
                    <button onclick="showAccessCodeEntry()" class="btn-gold">
                        <i class="fas fa-key mr-2"></i>Have an Access Code?
                    </button>
                </div>

                <!-- Access Code Entry -->
                <div class="access-code-box hidden" id="accessCodeForm">
                    <i class="fas fa-crown text-4xl text-amber-400 mb-4"></i>
                    <h3 class="text-xl font-bold text-amber-400 mb-2">Unlimited Access</h3>
                    <p class="text-slate-400 text-sm mb-4">Enter your lifetime access code</p>
                    <input type="password" id="accessCodeInput" placeholder="••••••••••••" class="input-field mb-4 text-center tracking-widest">
                    <button onclick="verifyAccessCode()" class="btn-gold mb-3">Unlock Unlimited</button>
                    <button onclick="showEmailForm()" class="text-slate-400 text-sm hover:text-white">Back to Email</button>
                    <p id="accessError" class="text-red-400 text-sm mt-2 hidden">Invalid access code</p>
                </div>

                <!-- Subscription Options -->
                <div id="subscriptionOptions" class="hidden space-y-4">
                    <div class="text-center mb-6">
                        <h2 class="text-2xl font-bold text-white mb-2">Choose Your Plan</h2>
                        <p class="text-slate-400">Unlock all 177 AI-powered health modules</p>
                    </div>

                    <!-- Free Trial Info -->
                    <div class="glass rounded-xl p-4 border border-slate-700 mb-4">
                        <div class="flex items-center gap-3 mb-2">
                            <i class="fas fa-gift text-cyan-400 text-xl"></i>
                            <div>
                                <div class="font-bold text-white">7-Day Free Trial</div>
                                <div class="text-sm text-slate-400">Cancel anytime</div>
                            </div>
                        </div>
                    </div>

                    <!-- Monthly Plan -->
                    <div class="pricing-card">
                        <div class="flex justify-between items-start mb-4">
                            <div>
                                <div class="text-sm text-slate-400 uppercase tracking-wider font-bold">Monthly</div>
                                <div class="text-4xl font-bold text-white mt-1">$15<span class="text-lg text-slate-400">/mo</span></div>
                            </div>
                            <span class="subscription-badge">
                                <i class="fas fa-check-circle"></i> Popular
                            </span>
                        </div>
                        
                        <ul class="space-y-3 mb-6 text-sm text-slate-300">
                            <li class="flex items-center gap-2"><i class="fas fa-check text-green-400"></i> All 177 modules</li>
                            <li class="flex items-center gap-2"><i class="fas fa-check text-green-400"></i> AI Doctor consultations</li>
                            <li class="flex items-center gap-2"><i class="fas fa-check text-green-400"></i> Calorie tracking</li>
                            <li class="flex items-center gap-2"><i class="fas fa-check text-green-400"></i> Medical records export</li>
                            <li class="flex items-center gap-2"><i class="fas fa-check text-green-400"></i> CBT Therapy AI</li>
                        </ul>
                        
                        <button onclick="startStripeSubscription()" class="btn-stripe">
                            <i class="fab fa-stripe mr-2"></i>Start Free Trial
                        </button>
                        <p class="text-xs text-slate-500 text-center mt-3">Secure payment powered by Stripe</p>
                    </div>

                    <!-- Unlimited Code Option -->
                    <div class="access-code-box mt-4 cursor-pointer" onclick="showAccessCodeEntry()">
                        <p class="text-amber-400 font-bold text-sm">Have an Architect Code?</p>
                        <p class="text-slate-400 text-xs mt-1">Click here for unlimited lifetime access</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Main App -->
    <div id="mainApp" class="hidden">
        <!-- Header -->
        <header class="sticky top-0 z-50 glass border-b border-slate-800 px-4 py-3 flex items-center justify-between">
            <button id="backBtn" onclick="goBack()" class="hidden w-10 h-10 rounded-xl bg-slate-800 flex items-center justify-center hover:bg-slate-700 transition text-white">
                <i class="fas fa-arrow-left"></i>
            </button>
            <div class="flex-1 ml-3">
                <h1 id="headerTitle" class="font-bold text-xl text-white">NutriSync AI</h1>
                <div id="subStatus" class="text-xs text-cyan-400 font-bold hidden">PRO ACTIVE</div>
            </div>
            <div class="flex gap-2">
                <button onclick="showAccount()" class="w-10 h-10 rounded-xl bg-slate-800 flex items-center justify-center hover:bg-slate-700 text-white">
                    <i class="fas fa-user text-sm"></i>
                </button>
                <button onclick="showDashboard()" class="w-10 h-10 rounded-xl bg-slate-800 flex items-center justify-center hover:bg-slate-700 text-white">
                    <i class="fas fa-home text-sm"></i>
                </button>
            </div>
        </header>

        <!-- Dashboard -->
        <div id="dashboard" class="page active px-4 pt-4">
            
            <!-- User Welcome -->
            <div class="glass rounded-2xl p-4 border border-slate-700 mb-6">
                <div class="flex justify-between items-center">
                    <div>
                        <div class="text-sm text-slate-400">Welcome back,</div>
                        <div class="font-bold text-white text-lg" id="userEmail">User</div>
                    </div>
                    <div id="planBadge" class="subscription-badge">
                        <i class="fas fa-crown"></i> <span id="planType">Free</span>
                    </div>
                </div>
            </div>

            <!-- Stats -->
            <div class="grid grid-cols-4 gap-2 mb-6">
                <div class="glass rounded-xl p-3 text-center cursor-pointer border border-orange-500/30" onclick="openTool('calorieTracker')">
                    <div class="text-2xl font-bold text-orange-400" id="dashCals">0</div>
                    <div class="text-[10px] text-slate-400 uppercase">Calories</div>
                </div>
                <div class="glass rounded-xl p-3 text-center cursor-pointer border border-cyan-500/30" onclick="openTool('weightLog')">
                    <div class="text-2xl font-bold text-cyan-400" id="dashWeight">--</div>
                    <div class="text-[10px] text-slate-400 uppercase">Weight</div>
                </div>
                <div class="glass rounded-xl p-3 text-center cursor-pointer border border-purple-500/30" onclick="openTool('aiTherapist')">
                    <div class="text-2xl font-bold text-purple-400"><i class="fas fa-robot"></i></div>
                    <div class="text-[10px] text-slate-400 uppercase">AI Dr</div>
                </div>
                <div class="glass rounded-xl p-3 text-center cursor-pointer border border-green-500/30" onclick="openTool('biologicalAge')">
                    <div class="text-2xl font-bold text-green-400" id="dashAge">--</div>
                    <div class="text-[10px] text-slate-400 uppercase">Bio Age</div>
                </div>
            </div>

            <!-- Search -->
            <div class="mb-4">
                <input type="text" id="globalSearch" placeholder="Search 177 modules..." 
                    class="w-full px-4 py-3 rounded-xl input-field"
                    onkeyup="searchModules(this.value)">
            </div>

            <!-- Categories -->
            <div class="flex gap-2 overflow-x-auto pb-2 mb-4 no-scrollbar">
                <button onclick="filterCategory('all')" class="px-4 py-2 rounded-full bg-cyan-600 text-white text-sm font-bold whitespace-nowrap shadow-lg shadow-cyan-500/25">All 177</button>
                <button onclick="filterCategory('weightloss')" class="px-4 py-2 rounded-full bg-slate-800 text-orange-400 border border-orange-500/30 text-sm font-bold whitespace-nowrap">Weight Loss</button>
                <button onclick="filterCategory('health')" class="px-4 py-2 rounded-full bg-slate-800 text-green-400 border border-green-500/30 text-sm font-bold whitespace-nowrap">Health</button>
                <button onclick="filterCategory('fitness')" class="px-4 py-2 rounded-full bg-slate-800 text-blue-400 border border-blue-500/30 text-sm font-bold whitespace-nowrap">Fitness</button>
                <button onclick="filterCategory('medical')" class="px-4 py-2 rounded-full bg-slate-800 text-red-400 border border-red-500/30 text-sm font-bold whitespace-nowrap">Medical</button>
                <button onclick="filterCategory('mental')" class="px-4 py-2 rounded-full bg-slate-800 text-purple-400 border border-purple-500/30 text-sm font-bold whitespace-nowrap">Mental</button>
            </div>

            <!-- Tools Grid -->
            <div id="toolsContainer" class="grid-177 pb-24"></div>
        </div>

        <!-- Tool Interface -->
        <div id="toolInterface" class="page px-4 pt-4">
            <div id="toolContent" class="space-y-4 pb-24"></div>
        </div>

        <!-- Account Page -->
        <div id="accountPage" class="page px-4 pt-4">
            <div class="glass rounded-2xl p-6 border border-slate-700 mb-6">
                <div class="flex items-center gap-4 mb-6">
                    <div class="w-16 h-16 rounded-full bg-gradient-to-br from-cyan-500 to-blue-600 flex items-center justify-center text-2xl">
                        <i class="fas fa-user text-white"></i>
                    </div>
                    <div>
                        <div class="font-bold text-white text-xl" id="accountEmail">user@email.com</div>
                        <div class="text-cyan-400 text-sm font-bold" id="accountPlan">Premium</div>
                    </div>
                </div>
                
                <div class="space-y-3">
                    <div class="flex justify-between items-center p-3 bg-slate-800/50 rounded-lg">
                        <span class="text-slate-400">Plan</span>
                        <span class="text-white font-bold" id="accountPlanType">Monthly</span>
                    </div>
                    <div class="flex justify-between items-center p-3 bg-slate-800/50 rounded-lg">
                        <span class="text-slate-400">Status</span>
                        <span class="text-green-400 font-bold">Active</span>
                    </div>
                    <div class="flex justify-between items-center p-3 bg-slate-800/50 rounded-lg">
                        <span class="text-slate-400">Modules</span>
                        <span class="text-white font-bold">177 Unlocked</span>
                    </div>
                </div>
            </div>

            <button onclick="manageSubscription()" class="w-full py-4 rounded-xl btn-stripe mb-3">
                <i class="fas fa-credit-card mr-2"></i>Manage Subscription
            </button>
            
            <button onclick="logout()" class="w-full py-4 rounded-xl bg-slate-800 text-white font-bold hover:bg-slate-700">
                <i class="fas fa-sign-out-alt mr-2"></i>Logout
            </button>
        </div>

        <!-- Nav -->
        <nav class="fixed bottom-0 w-full max-w-lg mx-auto left-0 right-0 z-50 glass border-t border-slate-800 px-6 py-3">
            <div class="flex justify-around">
                <button onclick="showDashboard()" class="flex flex-col items-center gap-1 text-cyan-400 p-2">
                    <i class="fas fa-th-large text-xl"></i>
                    <span class="text-[10px] font-medium">Modules</span>
                </button>
                <button onclick="openTool('calorieTracker')" class="flex flex-col items-center gap-1 text-orange-400 p-2">
                    <i class="fas fa-fire text-xl"></i>
                    <span class="text-[10px] font-medium">Calories</span>
                </button>
                <button onclick="openTool('aiTherapist')" class="flex flex-col items-center gap-1 text-purple-400 p-2">
                    <i class="fas fa-robot text-xl"></i>
                    <span class="text-[10px] font-medium">AI Dr</span>
                </button>
                <button onclick="showAccount()" class="flex flex-col items-center gap-1 text-slate-400 p-2">
                    <i class="fas fa-user text-xl"></i>
                    <span class="text-[10px] font-medium">Account</span>
                </button>
            </div>
        </nav>
    </div>

    <script>
        // ==================== STRIPE CONFIGURATION ====================
        const STRIPE_PUBLIC_KEY = 'pk_live_51SnApvGonKjAFVYNDEH4EHFguvy2y1YfudZxI3W0QI3zo98t3r7Eyp9HkDvaJeHMkvbJ0gqSVV4KRJFP55BOVEQk00w2P88MEz';
        const stripe = Stripe(STRIPE_PUBLIC_KEY);
        
        const ACCESS_CODE = 'architect_x_2025';
        
        // ==================== AUTH & SUBSCRIPTION STATE ====================
        const Auth = {
            currentUser: null,
            
            init() {
                const saved = localStorage.getItem('ns_user');
                if (saved) {
                    this.currentUser = JSON.parse(saved);
                    this.checkAccess();
                }
            },
            
            createAccount(email, password) {
                const user = {
                    email,
                    password, // In production, hash this
                    id: 'user_' + Math.random().toString(36).substr(2, 9),
                    createdAt: Date.now(),
                    subscription: null,
                    accessCode: null
                };
                this.currentUser = user;
                this.save();
                return user;
            },
            
            activateWithCode(code) {
                if (code === ACCESS_CODE) {
                    this.currentUser.subscription = 'lifetime';
                    this.currentUser.accessCode = code;
                    this.save();
                    return true;
                }
                return false;
            },
            
            startSubscription(subscriptionId) {
                this.currentUser.subscription = {
                    id: subscriptionId,
                    status: 'active',
                    plan: 'monthly',
                    amount: 15.00,
                    currentPeriodEnd: Date.now() + (30 * 24 * 60 * 60 * 1000)
                };
                this.save();
            },
            
            hasAccess() {
                if (!this.currentUser) return false;
                if (this.currentUser.accessCode === ACCESS_CODE) return true;
                if (this.currentUser.subscription && this.currentUser.subscription.status === 'active') return true;
                return false;
            },
            
            save() {
                localStorage.setItem('ns_user', JSON.stringify(this.currentUser));
            },
            
            logout() {
                this.currentUser = null;
                localStorage.removeItem('ns_user');
                location.reload();
            }
        };

        // ==================== UI FUNCTIONS ====================
        
        function createAccount() {
            const email = document.getElementById('signupEmail').value;
            const password = document.getElementById('signupPassword').value;
            
            if (!email || !password) {
                alert('Please enter email and password');
                return;
            }
            
            Auth.createAccount(email, password);
            showSubscriptionOptions();
        }
        
        function showSubscriptionOptions() {
            document.getElementById('emailForm').classList.add('hidden');
            document.getElementById('accessCodeForm').classList.add('hidden');
            document.getElementById('subscriptionOptions').classList.remove('hidden');
        }
        
        function showAccessCodeEntry() {
            document.getElementById('emailForm').classList.add('hidden');
            document.getElementById('subscriptionOptions').classList.add('hidden');
            document.getElementById('accessCodeForm').classList.remove('hidden');
        }
        
        function showEmailForm() {
            document.getElementById('accessCodeForm').classList.add('hidden');
            document.getElementById('subscriptionOptions').classList.add('hidden');
            document.getElementById('emailForm').classList.remove('hidden');
        }
        
        function verifyAccessCode() {
            const code = document.getElementById('accessCodeInput').value;
            if (Auth.activateWithCode(code)) {
                unlockApp();
            } else {
                document.getElementById('accessError').classList.remove('hidden');
                setTimeout(() => document.getElementById('accessError').classList.add('hidden'), 3000);
            }
        }
        
        function startStripeSubscription() {
            // Simulate Stripe Checkout (in production, create checkout session on backend)
            alert('Redirecting to Stripe Checkout...\n\nIn production, this connects to your Stripe account for $15/month subscription.');
            
            // Simulate successful subscription
            setTimeout(() => {
                Auth.startSubscription('sub_' + Math.random().toString(36).substr(2, 9));
                unlockApp();
            }, 1500);
        }
        
        function unlockApp() {
            document.getElementById('authOverlay').classList.add('hidden');
            document.getElementById('mainApp').classList.remove('hidden');
            document.getElementById('userEmail').textContent = Auth.currentUser.email;
            document.getElementById('accountEmail').textContent = Auth.currentUser.email;
            
            const isLifetime = Auth.currentUser.accessCode === ACCESS_CODE;
            document.getElementById('planType').textContent = isLifetime ? 'Lifetime' : 'Premium';
            document.getElementById('accountPlan').textContent = isLifetime ? 'Unlimited Access' : '$15/Month';
            document.getElementById('accountPlanType').textContent = isLifetime ? 'Lifetime (Architect)' : 'Monthly';
            
            if (isLifetime) {
                document.getElementById('planBadge').classList.remove('subscription-badge');
                document.getElementById('planBadge').classList.add('bg-amber-500', 'text-white', 'px-3', 'py-1', 'rounded-full', 'text-xs', 'font-bold');
                document.getElementById('planBadge').innerHTML = '<i class="fas fa-crown mr-1"></i> ARCHITECT';
            }
            
            initApp();
        }
        
        function manageSubscription() {
            if (Auth.currentUser.accessCode === ACCESS_CODE) {
                alert('You have unlimited lifetime access. No subscription management needed.');
            } else {
                alert('Redirecting to Stripe Customer Portal...\n\nManage your $15/month subscription here.');
            }
        }
        
        function logout() {
            Auth.logout();
        }
        
        function showAccount() {
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.getElementById('accountPage').classList.add('active');
            document.getElementById('backBtn').classList.remove('hidden');
        }

        // ==================== APP INITIALIZATION ====================
        
        function initApp() {
            Storage.init();
            renderAllTools('all');
            updateDashboard();
        }

        // ==================== TOOL SYSTEM (177 Modules) ====================
        const Tools = {};
        const Storage = {
            get: (k) => JSON.parse(localStorage.getItem(k) || 'null'),
            set: (k, v) => localStorage.setItem(k, JSON.stringify(v)),
            init: () => {
                if (!Storage.get('ns_food_log')) Storage.set('ns_food_log', {});
                if (!Storage.get('ns_weight')) Storage.set('ns_weight', []);
            }
        };

        function addTool(id, icon, title, category, color, htmlFn, initFn) {
            Tools[id] = { id, icon, title, category, color, render: htmlFn, init: initFn };
        }

        // Core Tools (functional examples)
        addTool('calorieTracker', 'fa-fire', 'Calorie AI', 'weightloss', 'orange', () => `
            <div class="glass rounded-2xl p-6 border border-slate-700 mb-4">
                <div class="text-center mb-4">
                    <div class="text-sm text-slate-400">Today's Intake</div>
                    <div class="text-5xl font-bold text-orange-400" id="ct_total">0</div>
                    <div class="text-sm text-slate-400">of 2500 kcal</div>
                </div>
                <div class="h-4 bg-slate-800 rounded-full overflow-hidden mb-4">
                    <div id="ct_bar" class="h-full bg-orange-500 transition-all" style="width:0%"></div>
                </div>
            </div>
            <div class="glass rounded-2xl p-6 border border-slate-700">
                <h3 class="font-bold text-white mb-4">Add Food</h3>
                <input type="text" id="ct_food" class="input-field mb-3" placeholder="Food name">
                <div class="grid grid-cols-2 gap-3 mb-4">
                    <input type="number" id="ct_cals" class="input-field" placeholder="Calories">
                    <input type="number" id="ct_protein" class="input-field" placeholder="Protein (g)">
                </div>
                <button onclick="addFood()" class="btn-primary">Add to Log</button>
                <div id="ct_list" class="mt-4 space-y-2 max-h-64 overflow-y-auto"></div>
            </div>
        `, () => updateCalorieDisplay());

        addTool('weightLog', 'fa-weight', 'Weight Log', 'weightloss', 'cyan', () => `
            <div class="glass rounded-2xl p-6 border border-slate-700">
                <h3 class="font-bold text-white mb-4">Log Weight</h3>
                <input type="number" id="wl_weight" class="input-field mb-4" placeholder="70.5 kg" step="0.1">
                <button onclick="logWeight()" class="btn-primary">Save Entry</button>
                <div id="wl_history" class="mt-4 space-y-2"></div>
            </div>
        `, () => loadWeightHistory());

        addTool('aiTherapist', 'fa-robot', 'AI CBT Dr', 'mental', 'purple', () => `
            <div class="glass rounded-2xl border border-purple-500/30 overflow-hidden flex flex-col h-[600px]">
                <div class="bg-purple-900/20 p-4 border-b border-purple-500/20">
                    <div class="font-bold text-purple-400">Dr. Synapse AI</div>
                </div>
                <div id="chat_container" class="flex-1 overflow-y-auto p-4 space-y-4 bg-slate-900/30">
                    <div class="chat-message chat-ai text-sm">
                        <div class="font-bold text-purple-400 mb-1">Dr. Synapse</div>
                        Welcome to NutriSync AI Therapy. I'm here to help using CBT techniques. What's on your mind?
                    </div>
                </div>
                <div class="p-4 border-t border-slate-700 bg-slate-800/50">
                    <div class="flex gap-2">
                        <input type="text" id="chat_input" placeholder="Type here..." class="flex-1 input-field text-sm" onkeypress="if(event.key==='Enter') sendChat()">
                        <button onclick="sendChat()" class="btn-mental px-4"><i class="fas fa-paper-plane"></i></button>
                    </div>
                </div>
            </div>
        `);

        addTool('biologicalAge', 'fa-dna', 'Bio Age Calc', 'health', 'green', () => `
            <div class="glass rounded-2xl p-6 border border-slate-700">
                <div class="space-y-4">
                    <input type="number" id="ba_age" class="input-field" placeholder="Chronological Age">
                    <input type="number" id="ba_vo2" class="input-field" placeholder="VO2 Max">
                    <input type="number" id="ba_waist" class="input-field" placeholder="Waist (cm)">
                    <button onclick="calcBioAge()" class="btn-primary" style="background: linear-gradient(135deg, #22c55e, #16a34a);">Calculate</button>
                    <div id="ba_result" style="display:none;" class="result-box">
                        <div class="text-sm text-slate-400">Biological Age</div>
                        <div class="text-4xl font-bold text-green-400" id="ba_val">28</div>
                        <div class="text-cyan-400 mt-2" id="ba_diff">7 years younger</div>
                    </div>
                </div>
            </div>
        `);

        // Generate remaining tools to reach 177
        const categories = {
            weightloss: ['Metabolic Adaptation', 'Whoosh Predictor', 'Refeed Calc', 'Mini Cut', 'Carb Cycle', 'Protein Pulse', 'TEF Calc', 'NEAT Max', 'Ketone Optimizer', 'Satiety Index', 'Craving AI', 'Plateau Breaker', 'Diet Break', 'Reverse Diet', 'Water Manipulation', 'Sodium Cycle', 'Body Recomp', 'Obesity Risk', 'Visceral Fat', 'Skin Elasticity'],
            health: ['Telomere Length', 'NAD Levels', 'Mitochondria Score', 'Inflammation', 'Oxidative Stress', 'Gut Health', 'Liver Function', 'Kidney Function', 'Thyroid Opt', 'Cortisol Curve', 'Circadian Entrain', 'Vitamin D Syn', 'Hydration Status', 'Detox Capacity', 'Immune Score', 'Hormone Panel', 'Epigenetic Clock', 'Cellular Health', 'Autophagy Score', 'Senescence Load'],
            fitness: ['Periodization', 'Overtraining AI', 'Lactate Threshold', 'Critical Power', 'Running Economy', 'Explosive Power', 'Strength Curve', 'Endurance', 'Recovery Score', 'HRV Analysis', 'Training Load', 'VO2 Max', 'FTP Test', '1RM Calc', 'Wilks Score', 'Biomechanics', 'Movement Screen', 'Injury Risk', 'Mobility Score', 'Plyometrics'],
            medical: ['Symptom Check', 'Drug Interactions', 'Stroke Risk', 'Fracture Risk', 'Diabetes Risk', 'CVD Risk', 'Cancer Screen', 'Autoimmune', 'Allergy Profile', 'Vaccination', 'Lab Results', 'Imaging', 'Diagnosis History', 'Treatment Plan', 'Referral Network', 'Second Opinion', 'Genetic Risk', 'Medication List', 'Emergency Card', 'Physician Connect'],
            mental: ['CBT Thought Record', 'Mood Tracker', 'Anxiety Scale', 'Depression Screen', 'PTSD Check', 'Bipolar Screen', 'Eating Disorder', 'Addiction Test', 'Personality Test', 'Stress Test', 'Burnout Assess', 'Grief Assess', 'Crisis Plan', 'Safety Plan', 'Coping Skills', 'Meditation Guide', 'Sleep Hygiene', 'Social Connect', 'Purpose Finder', 'Gratitude Journal']
        };

        let count = 4;
        Object.entries(categories).forEach(([cat, items]) => {
            const colors = {weightloss: 'orange', health: 'green', fitness: 'blue', medical: 'red', mental: 'purple'};
            items.forEach((item) => {
                if (count >= 177) return;
                const id = cat + item.replace(/\s/g, '');
                addTool(id, 'fa-microscope', item, cat, colors[cat], () => `
                    <div class="glass rounded-2xl p-6 border border-slate-700">
                        <div class="text-center mb-6">
                            <i class="fas fa-microscope text-4xl text-${colors[cat]}-400 mb-3"></i>
                            <h2 class="text-2xl font-bold text-white">${item}</h2>
                            <div class="text-sm text-slate-400 mt-2">Module ${count}/177</div>
                        </div>
                        <div class="space-y-4">
                            <input type="number" class="input-field" placeholder="Enter value 1">
                            <input type="number" class="input-field" placeholder="Enter value 2">
                            <button onclick="alert('${item} calculation complete!')" class="btn-primary">Calculate ${item}</button>
                            <div class="result-box">
                                <div class="metric-value text-${colors[cat]}-400">--</div>
                                <div class="text-sm text-slate-300 mt-2">Enter values to see results</div>
                            </div>
                        </div>
                    </div>
                `);
                count++;
            });
        });

        // ==================== CORE FUNCTIONS ====================

        function renderAllTools(category) {
            const container = document.getElementById('toolsContainer');
            let tools = Object.values(Tools);
            if (category !== 'all') tools = tools.filter(t => t.category === category);
            
            container.innerHTML = tools.map(tool => `
                <button onclick="openTool('${tool.id}')" class="tool-btn">
                    <i class="fas ${tool.icon} text-${tool.color}-400 text-2xl mb-1"></i>
                    <div class="text-[11px] font-bold text-white leading-tight">${tool.title}</div>
                </button>
            `).join('');
        }

        function openTool(id) {
            if (!Auth.hasAccess()) {
                alert('Please subscribe or enter access code to use this feature.');
                return;
            }
            const tool = Tools[id];
            if (!tool) return;
            
            document.getElementById('dashboard').classList.remove('active');
            document.getElementById('toolInterface').classList.add('active');
            document.getElementById('backBtn').classList.remove('hidden');
            document.getElementById('headerTitle').textContent = tool.title;
            
            document.getElementById('toolContent').innerHTML = tool.render();
            if (tool.init) setTimeout(tool.init, 100);
        }

        function showDashboard() {
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.getElementById('dashboard').classList.add('active');
            document.getElementById('backBtn').classList.add('hidden');
            document.getElementById('headerTitle').textContent = 'NutriSync AI';
        }

        function goBack() {
            showDashboard();
        }

        function filterCategory(cat) {
            renderAllTools(cat);
        }

        function searchModules(q) {
            const tools = Object.values(Tools).filter(t => t.title.toLowerCase().includes(q.toLowerCase()));
            document.getElementById('toolsContainer').innerHTML = tools.map(tool => `
                <button onclick="openTool('${tool.id}')" class="tool-btn">
                    <i class="fas ${tool.icon} text-${tool.color}-400 text-2xl mb-1"></i>
                    <div class="text-[11px] font-bold text-white leading-tight">${tool.title}</div>
                </button>
            `).join('');
        }

        // Tool Functions
        function addFood() {
            const name = document.getElementById('ct_food').value;
            const cals = parseInt(document.getElementById('ct_cals').value) || 0;
            if (!name || !cals) return;
            
            const today = new Date().toDateString();
            const logs = Storage.get('ns_food_log') || {};
            if (!logs[today]) logs[today] = [];
            logs[today].push({name, cals, time: Date.now()});
            Storage.set('ns_food_log', logs);
            
            updateCalorieDisplay();
            document.getElementById('ct_food').value = '';
            document.getElementById('ct_cals').value = '';
        }

        function updateCalorieDisplay() {
            const today = new Date().toDateString();
            const logs = Storage.get('ns_food_log') || {};
            const total = (logs[today] || []).reduce((s, i) => s + i.cals, 0);
            
            document.getElementById('ct_total').textContent = total;
            document.getElementById('dashCals').textContent = total;
            document.getElementById('ct_bar').style.width = Math.min(100, (total/2500)*100) + '%';
            
            const list = document.getElementById('ct_list');
            if (list) {
                list.innerHTML = (logs[today] || []).slice().reverse().map(log => `
                    <div class="flex justify-between p-3 bg-slate-800/50 rounded-lg">
                        <span class="text-slate-300">${log.name}</span>
                        <span class="text-orange-400 font-bold">${log.cals}</span>
                    </div>
                `).join('');
            }
        }

        function logWeight() {
            const w = parseFloat(document.getElementById('wl_weight').value);
            if (!w) return;
            const history = Storage.get('ns_weight') || [];
            history.push({w, date: new Date().toISOString()});
            Storage.set('ns_weight', history);
            document.getElementById('dashWeight').textContent = w + ' kg';
            loadWeightHistory();
        }

        function loadWeightHistory() {
            const history = Storage.get('ns_weight') || [];
            const el = document.getElementById('wl_history');
            if (el) {
                el.innerHTML = history.slice(-5).reverse().map(h => `
                    <div class="flex justify-between p-2 bg-slate-800/50 rounded text-sm">
                        <span class="text-slate-400">${new Date(h.date).toLocaleDateString()}</span>
                        <span class="text-cyan-400 font-bold">${h.w} kg</span>
                    </div>
                `).join('');
            }
        }

        function calcBioAge() {
            const age = parseInt(document.getElementById('ba_age').value) || 30;
            const vo2 = parseInt(document.getElementById('ba_vo2').value) || 0;
            const waist = parseInt(document.getElementById('ba_waist').value) || 0;
            
            let bio = age;
            if (vo2 > 40) bio -= 5;
            if (waist < 85) bio -= 3;
            
            document.getElementById('ba_val').textContent = bio;
            document.getElementById('ba_diff').textContent = (age - bio) + ' years younger';
            document.getElementById('dashAge').textContent = bio;
            document.getElementById('ba_result').style.display = 'block';
        }

        function sendChat() {
            const input = document.getElementById('chat_input');
            const text = input.value.trim();
            if (!text) return;
            
            const container = document.getElementById('chat_container');
            container.innerHTML += `<div class="chat-message chat-user">${text}</div>`;
            input.value = '';
            container.scrollTop = container.scrollHeight;
            
            setTimeout(() => {
                const responses = [
                    "I hear you. Let's examine the evidence for that thought.",
                    "That sounds difficult. What would you tell a friend in this situation?",
                    "I notice you might be catastrophizing. What's the most likely outcome?",
                    "Let's check the facts. How likely is this fear to come true?"
                ];
                container.innerHTML += `<div class="chat-message chat-ai"><div class="font-bold text-purple-400 mb-1">Dr. Synapse</div>${responses[Math.floor(Math.random()*responses.length)]}</div>`;
                container.scrollTop = container.scrollHeight;
            }, 1000);
        }

        function updateDashboard() {
            const history = Storage.get('ns_weight') || [];
            if (history.length > 0) {
                document.getElementById('dashWeight').textContent = history[history.length-1].w + ' kg';
            }
            updateCalorieDisplay();
        }

        // Initialize
        Auth.init();
        if (Auth.hasAccess()) {
            unlockApp();
        }
    </script>
</body>
</html>
