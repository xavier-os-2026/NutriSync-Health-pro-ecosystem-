<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#0f172a">
    <title>NutriSync Pro | AI HealthOS</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/quagga/0.12.1/quagga.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&family=JetBrains+Mono:wght@400;700&display=swap');
        
        * { font-family: 'Inter', sans-serif; -webkit-tap-highlight-color: transparent; }
        .mono { font-family: 'JetBrains Mono', monospace; }
        
        body {
            background: #020617;
            color: #e2e8f0;
            overflow-x: hidden;
        }
        
        .glass {
            background: rgba(15, 23, 42, 0.6);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(51, 65, 85, 0.5);
        }
        
        .input-field {
            background: rgba(2, 6, 23, 0.8);
            border: 1px solid rgba(71, 85, 105, 0.8);
            color: white;
            transition: all 0.2s;
        }
        
        .input-field:focus {
            border-color: #06b6d4;
            box-shadow: 0 0 0 3px rgba(6, 182, 212, 0.1);
            outline: none;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #0891b2, #2563eb);
            color: white;
            font-weight: 600;
        }
        
        .btn-primary:active { transform: scale(0.98); }
        
        .btn-medical {
            background: linear-gradient(135deg, #dc2626, #991b1b);
            color: white;
            font-weight: 600;
        }
        
        .btn-ai {
            background: linear-gradient(135deg, #7c3aed, #4f46e5);
            color: white;
            font-weight: 600;
        }
        
        .page {
            display: none;
            min-height: 100vh;
            padding-bottom: 100px;
        }
        
        .page.active { display: block; animation: fadeIn 0.3s ease; }
        
        @keyframes fadeIn { from { opacity: 0; transform: translateX(10px); } to { opacity: 1; } }
        
        .tool-btn {
            background: rgba(30, 41, 59, 0.4);
            border: 1px solid rgba(71, 85, 105, 0.3);
            transition: all 0.2s;
        }
        
        .tool-btn:hover {
            background: rgba(51, 65, 85, 0.6);
            border-color: rgba(6, 182, 212, 0.5);
            transform: translateY(-2px);
        }
        
        .pro-badge {
            position: fixed;
            top: 12px;
            right: 12px;
            background: rgba(6, 182, 212, 0.15);
            border: 1px solid rgba(6, 182, 212, 0.3);
            color: #06b6d4;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 11px;
            font-weight: 700;
            z-index: 100;
        }
        
        .scanner-container {
            position: relative;
            width: 100%;
            height: 300px;
            background: #000;
            border-radius: 16px;
            overflow: hidden;
        }
        
        .scanner-line {
            position: absolute;
            width: 100%;
            height: 2px;
            background: #06b6d4;
            box-shadow: 0 0 10px #06b6d4;
            animation: scan 2s linear infinite;
            top: 0;
        }
        
        @keyframes scan {
            0% { top: 0; opacity: 0; }
            10% { opacity: 1; }
            90% { opacity: 1; }
            100% { top: 100%; opacity: 0; }
        }
        
        .chat-message {
            max-width: 80%;
            padding: 12px 16px;
            border-radius: 16px;
            margin-bottom: 12px;
            line-height: 1.5;
        }
        
        .chat-user {
            background: rgba(6, 182, 212, 0.2);
            border: 1px solid rgba(6, 182, 212, 0.3);
            margin-left: auto;
            border-bottom-right-radius: 4px;
        }
        
        .chat-ai {
            background: rgba(30, 41, 59, 0.8);
            border: 1px solid rgba(71, 85, 105, 0.5);
            margin-right: auto;
            border-bottom-left-radius: 4px;
        }
        
        .chat-medical {
            background: rgba(220, 38, 38, 0.1);
            border: 1px solid rgba(220, 38, 38, 0.3);
            margin-right: auto;
            border-bottom-left-radius: 4px;
        }
        
        .severity-low { border-left: 4px solid #22c55e; }
        .severity-medium { border-left: 4px solid #eab308; }
        .severity-high { border-left: 4px solid #f97316; }
        .severity-critical { border-left: 4px solid #dc2626; }
        
        .food-card {
            background: rgba(30, 41, 59, 0.6);
            border: 1px solid rgba(71, 85, 105, 0.3);
            transition: all 0.2s;
        }
        
        .food-card:hover {
            border-color: rgba(6, 182, 212, 0.5);
            transform: translateY(-2px);
        }
        
        .doctor-portal {
            background: linear-gradient(135deg, rgba(220, 38, 38, 0.1), rgba(153, 27, 27, 0.05));
            border: 1px solid rgba(220, 38, 38, 0.3);
        }
        
        .module-description {
            background: rgba(30, 41, 59, 0.4);
            border-left: 3px solid;
            transition: all 0.3s ease;
        }
        
        .expandable-desc {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease;
        }
        
        .expandable-desc.expanded {
            max-height: 1000px;
        }
        
        .hidden-camera {
            display: none;
        }
        
        #interactive {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
    </style>
</head>
<body class="bg-slate-950">

    <!-- Pro Status -->
    <div id="proBadge" class="pro-badge hidden">
        <i class="fas fa-crown mr-1"></i>PRO ACTIVE
    </div>

    <!-- Auth Overlay -->
    <div id="authOverlay" class="fixed inset-0 z-[300] bg-slate-950 flex items-center justify-center p-6">
        <div class="w-full max-w-sm">
            <div class="text-center mb-8">
                <div class="w-20 h-20 mx-auto mb-4 rounded-2xl bg-gradient-to-br from-cyan-500 to-blue-600 flex items-center justify-center text-3xl shadow-2xl shadow-cyan-500/20">
                    <i class="fas fa-dna text-white"></i>
                </div>
                <h1 class="text-3xl font-bold mb-2 tracking-tight">NutriSync<span class="text-cyan-400"> Pro</span></h1>
                <p class="text-slate-400 text-sm">Complete Health Operating System</p>
            </div>
            
            <div class="space-y-3">
                <input type="password" id="authCode" placeholder="••••••••••••" 
                    class="w-full px-4 py-4 rounded-xl input-field text-center text-lg tracking-[0.2em] font-bold">
                <button onclick="authenticate()" class="w-full py-4 rounded-xl btn-primary text-lg font-bold shadow-lg shadow-cyan-500/25">
                    Unlock System
                </button>
                <button onclick="enterLimited()" class="w-full py-3 rounded-xl border border-slate-700 text-slate-400 text-sm hover:bg-slate-900">
                    Limited Access
                </button>
                <button onclick="showDoctorLogin()" class="w-full py-3 rounded-xl border border-red-900/50 text-red-400 text-sm hover:bg-red-950/30">
                    <i class="fas fa-user-md mr-2"></i>Physician Portal
                </button>
            </div>
            <p id="authError" class="text-red-400 text-sm text-center mt-4 hidden animate-pulse">Invalid access credentials</p>
        </div>
    </div>

    <!-- Doctor Auth Overlay -->
    <div id="doctorAuthOverlay" class="fixed inset-0 z-[301] bg-slate-950 flex items-center justify-center p-6 hidden">
        <div class="w-full max-w-sm">
            <div class="text-center mb-8">
                <div class="w-20 h-20 mx-auto mb-4 rounded-2xl bg-gradient-to-br from-red-600 to-red-800 flex items-center justify-center text-3xl shadow-2xl shadow-red-500/20">
                    <i class="fas fa-user-md text-white"></i>
                </div>
                <h1 class="text-3xl font-bold mb-2 tracking-tight text-red-400">Medical Portal</h1>
                <p class="text-slate-400 text-sm">HIPAA-Compliant Clinical Access</p>
            </div>
            
            <div class="space-y-3">
                <input type="text" id="docId" placeholder="Medical License ID" class="w-full px-4 py-3 rounded-xl input-field">
                <input type="password" id="docPin" placeholder="Secure PIN" class="w-full px-4 py-3 rounded-xl input-field">
                <input type="text" id="docFacility" placeholder="Facility Code" class="w-full px-4 py-3 rounded-xl input-field">
                <button onclick="authenticateDoctor()" class="w-full py-4 rounded-xl btn-medical text-lg font-bold shadow-lg shadow-red-500/25">
                    Access Patient Data
                </button>
                <button onclick="backToMainAuth()" class="w-full py-3 rounded-xl border border-slate-700 text-slate-400 text-sm hover:bg-slate-900">
                    Back to Patient Access
                </button>
            </div>
            <p id="docAuthError" class="text-red-400 text-sm text-center mt-4 hidden">Invalid medical credentials</p>
        </div>
    </div>

    <!-- App Container -->
    <div class="max-w-lg mx-auto relative">
        
        <!-- Header -->
        <header class="sticky top-0 z-50 glass border-b border-slate-800 px-4 py-3 flex items-center justify-between">
            <button id="backBtn" onclick="goBack()" class="hidden w-10 h-10 rounded-xl bg-slate-800 flex items-center justify-center hover:bg-slate-700 transition">
                <i class="fas fa-arrow-left"></i>
            </button>
            <h1 id="headerTitle" class="font-bold text-xl flex-1 ml-3">Command Center</h1>
            <div class="flex gap-2">
                <button onclick="showExport()" class="w-10 h-10 rounded-xl bg-slate-800 flex items-center justify-center hover:bg-slate-700">
                    <i class="fas fa-database text-sm"></i>
                </button>
                <button id="doctorBtn" onclick="showDoctorDashboard()" class="hidden w-10 h-10 rounded-xl bg-red-900/30 border border-red-500/30 text-red-400 flex items-center justify-center hover:bg-red-900/50">
                    <i class="fas fa-user-md text-sm"></i>
                </button>
            </div>
        </header>

        <!-- MAIN DASHBOARD -->
        <div id="dashboard" class="page active px-4 pt-4">
            
            <!-- Live Metrics -->
            <div class="grid grid-cols-2 gap-3 mb-6">
                <div class="glass rounded-2xl p-4 border border-slate-700/50 cursor-pointer hover:border-cyan-500/50 transition" onclick="openTool('weightLog')">
                    <div class="text-slate-400 text-xs font-bold uppercase tracking-wider mb-1">Weight</div>
                    <div class="text-3xl font-bold metric-value text-white" id="liveWeight">--</div>
                    <div class="text-xs mt-1" id="weightChange">Tap to log</div>
                </div>
                
                <div class="glass rounded-2xl p-4 border border-slate-700/50 cursor-pointer hover:border-orange-500/50 transition" onclick="openTool('calorieTracker')">
                    <div class="text-slate-400 text-xs font-bold uppercase tracking-wider mb-1">Calories</div>
                    <div class="text-3xl font-bold metric-value text-orange-400" id="liveCalories">--</div>
                    <div class="text-xs text-slate-400 mt-1" id="calorieStatus">Tap to log</div>
                </div>
                
                <div class="glass rounded-2xl p-4 border border-slate-700/50 cursor-pointer hover:border-blue-500/50 transition" onclick="openTool('aiDoctor')">
                    <div class="text-slate-400 text-xs font-bold uppercase tracking-wider mb-1">AI Health</div>
                    <div class="text-3xl font-bold metric-value text-blue-400"><i class="fas fa-stethoscope"></i></div>
                    <div class="text-xs text-slate-400 mt-1">Consult AI Dr</div>
                </div>
                
                <div class="glass rounded-2xl p-4 border border-slate-700/50 cursor-pointer hover:border-cyan-500/50 transition" onclick="openTool('fastingTracker')">
                    <div class="text-slate-400 text-xs font-bold uppercase tracking-wider mb-1">Fasting</div>
                    <div class="text-3xl font-bold metric-value text-cyan-400 timer-display" id="liveFast">--</div>
                    <div class="text-xs text-slate-400 mt-1" id="fastStatus">Inactive</div>
                </div>
            </div>

            <!-- Quick Actions -->
            <div class="grid grid-cols-2 gap-3 mb-6">
                <button onclick="openTool('foodScanner')" class="glass rounded-2xl p-4 border border-cyan-500/30 hover:bg-cyan-500/10 transition text-left">
                    <div class="w-10 h-10 rounded-xl bg-cyan-500/20 flex items-center justify-center mb-2">
                        <i class="fas fa-camera text-cyan-400"></i>
                    </div>
                    <div class="font-bold text-sm">AI Food Scan</div>
                    <div class="text-xs text-slate-400">Barcode + Vision</div>
                </button>
                
                <button onclick="openTool('aiDoctor')" class="glass rounded-2xl p-4 border border-red-500/30 hover:bg-red-500/10 transition text-left">
                    <div class="w-10 h-10 rounded-xl bg-red-500/20 flex items-center justify-center mb-2">
                        <i class="fas fa-user-md text-red-400"></i>
                    </div>
                    <div class="font-bold text-sm text-red-400">AI Doctor</div>
                    <div class="text-xs text-slate-400">Symptom Analysis</div>
                </button>
            </div>

            <!-- Tools Directory -->
            <div class="mb-4">
                <div class="flex justify-between items-center mb-3 px-1">
                    <h2 class="font-bold text-lg">Tools Directory</h2>
                    <span class="text-xs bg-cyan-500/10 text-cyan-400 px-3 py-1 rounded-full border border-cyan-500/20">174+ Modules</span>
                </div>
                
                <!-- Search -->
                <input type="text" id="toolSearch" placeholder="Search tools..." 
                    class="w-full px-4 py-3 rounded-xl input-field mb-3"
                    oninput="filterTools(this.value)">
                
                <!-- Categories -->
                <div class="flex gap-2 overflow-x-auto pb-2 mb-2 no-scrollbar" id="categoryTabs">
                    <button onclick="filterCategory('all')" class="px-4 py-2 rounded-full bg-cyan-500 text-white text-sm font-medium whitespace-nowrap">All</button>
                    <button onclick="filterCategory('ai')" class="px-4 py-2 rounded-full bg-purple-900/30 text-purple-400 border border-purple-500/30 text-sm font-medium whitespace-nowrap">AI Tools</button>
                    <button onclick="filterCategory('nutrition')" class="px-4 py-2 rounded-full bg-slate-800 text-slate-400 text-sm font-medium whitespace-nowrap">Nutrition</button>
                    <button onclick="filterCategory('medical')" class="px-4 py-2 rounded-full bg-red-900/30 text-red-400 border border-red-500/30 text-sm font-medium whitespace-nowrap">Medical</button>
                </div>

                <!-- Tools Grid -->
                <div id="toolsContainer" class="grid grid-cols-3 gap-2 max-h-[500px] overflow-y-auto pb-20">
                    <!-- Populated by JS -->
                </div>
            </div>
        </div>

        <!-- TOOL PAGES -->
        <div id="toolInterface" class="page px-4 pt-4">
            <div id="toolContent" class="space-y-4 pb-24">
                <!-- Dynamic content -->
            </div>
        </div>

        <!-- DOCTOR DASHBOARD -->
        <div id="doctorDashboard" class="page px-4 pt-4">
            <div class="doctor-portal rounded-2xl p-6 mb-6">
                <div class="flex items-center gap-4 mb-4">
                    <div class="w-16 h-16 rounded-full bg-red-500/20 flex items-center justify-center">
                        <i class="fas fa-user-md text-3xl text-red-400"></i>
                    </div>
                    <div>
                        <h2 class="text-2xl font-bold text-red-400">Clinical Dashboard</h2>
                        <p class="text-sm text-slate-400">Dr. <span id="docNameDisplay">--</span> | License: <span id="docLicenseDisplay">--</span></p>
                    </div>
                </div>
                <div class="bg-red-500/10 border border-red-500/30 rounded-xl p-3 text-sm text-red-200">
                    <i class="fas fa-shield-alt mr-2"></i>HIPAA Compliance Mode Active. All access is logged and encrypted.
                </div>
            </div>

            <div class="space-y-4">
                <div class="glass rounded-2xl p-4 border border-slate-700">
                    <h3 class="font-bold mb-4 flex items-center gap-2">
                        <i class="fas fa-users text-cyan-400"></i> Patient Records
                    </h3>
                    <div id="patientList" class="space-y-3">
                        <!-- Populated dynamically -->
                    </div>
                </div>

                <div class="glass rounded-2xl p-4 border border-slate-700">
                    <h3 class="font-bold mb-4 flex items-center gap-2">
                        <i class="fas fa-ambulance text-red-400"></i> Critical Alerts
                    </h3>
                    <div id="criticalAlerts" class="space-y-2">
                        <div class="p-3 rounded-xl bg-red-500/10 border border-red-500/30 text-sm">
                            <div class="flex justify-between items-start">
                                <div>
                                    <div class="font-bold text-red-400">High Blood Pressure</div>
                                    <div class="text-slate-400">Patient ID: NS-2847 | 180/110 mmHg</div>
                                </div>
                                <span class="text-xs bg-red-500/20 text-red-400 px-2 py-1 rounded">2h ago</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- DATA MANAGEMENT -->
        <div id="dataPage" class="page px-4 pt-4">
            <h2 class="text-2xl font-bold mb-6">Data Center</h2>
            
            <div class="glass rounded-2xl p-6 mb-4 border border-slate-700">
                <h3 class="font-bold mb-4 flex items-center gap-2">
                    <i class="fas fa-download text-cyan-400"></i> Export Data
                </h3>
                <div class="space-y-3">
                    <button onclick="exportJSON()" class="w-full py-3 rounded-xl bg-slate-800 hover:bg-slate-700 flex items-center justify-between px-4 transition">
                        <span class="flex items-center gap-2"><i class="fas fa-file-code text-blue-400"></i> Full Database (JSON)</span>
                        <i class="fas fa-chevron-right text-slate-600"></i>
                    </button>
                    <button onclick="exportMedicalPDF()" class="w-full py-3 rounded-xl bg-red-900/20 border border-red-500/30 hover:bg-red-900/30 flex items-center justify-between px-4 transition">
                        <span class="flex items-center gap-2"><i class="fas fa-file-medical text-red-400"></i> Medical Report (PDF)</span>
                        <i class="fas fa-chevron-right text-slate-600"></i>
                    </button>
                </div>
            </div>

            <div class="glass rounded-2xl p-6 border border-slate-700">
                <h3 class="font-bold mb-4 flex items-center gap-2">
                    <i class="fas fa-cloud-upload-alt text-cyan-400"></i> Cloud Sync
                </h3>
                <button onclick="syncToCloud()" class="w-full py-3 rounded-xl btn-primary mb-3">
                    <i class="fas fa-sync-alt mr-2"></i>Sync to Secure Cloud
                </button>
                <p class="text-xs text-slate-500 text-center">End-to-end encrypted. Compliant with HIPAA, GDPR, and PIPEDA.</p>
            </div>
        </div>

    </div>

    <!-- Bottom Nav -->
    <nav class="fixed bottom-0 w-full max-w-lg mx-auto left-0 right-0 z-50 glass border-t border-slate-800 px-6 py-3">
        <div class="flex justify-around">
            <button onclick="showDashboard()" class="flex flex-col items-center gap-1 text-cyan-400 p-2">
                <i class="fas fa-home text-xl"></i>
                <span class="text-[10px] font-medium">Home</span>
            </button>
            <button onclick="openTool('foodScanner')" class="flex flex-col items-center gap-1 text-purple-400 p-2">
                <i class="fas fa-camera text-xl"></i>
                <span class="text-[10px] font-medium">Scan</span>
            </button>
            <button onclick="openTool('aiDoctor')" class="flex flex-col items-center gap-1 text-red-400 p-2">
                <i class="fas fa-user-md text-xl"></i>
                <span class="text-[10px] font-medium">AI Dr</span>
            </button>
            <button onclick="showExport()" class="flex flex-col items-center gap-1 text-slate-400 hover:text-slate-200 p-2">
                <i class="fas fa-cog text-xl"></i>
                <span class="text-[10px] font-medium">Data</span>
            </button>
        </div>
    </nav>

    <script>
        // ==================== ENHANCED DATABASE WITH MEDICAL & FOOD DATA ====================
        const DB = {
            keys: {
                PROFILE: 'ns_profile_v3',
                WEIGHTS: 'ns_weights_v3',
                MEALS: 'ns_meals_v3',
                WORKOUTS: 'ns_workouts_v3',
                WATER: 'ns_water_v3',
                FASTING: 'ns_fasting_v3',
                SETTINGS: 'ns_settings_v3',
                TOOL_DATA: 'ns_tool_data_v3',
                FOOD_LOG: 'ns_food_log_v3',
                MEDICAL_RECORDS: 'ns_medical_v3',
                AI_CONSULTATIONS: 'ns_ai_consults_v3',
                DOCTOR_ACCESS: 'ns_doctor_access_v3'
            },
            
            init: () => {
                Object.values(DB.keys).forEach(key => {
                    if (!localStorage.getItem(key)) {
                        localStorage.setItem(key, JSON.stringify(
                            key.includes('DATA') || key.includes('LOG') || key.includes('RECORDS') || key.includes('CONSULTATIONS') ? {} : []
                        ));
                    }
                });
                if (!DB.get(DB.keys.SETTINGS)) {
                    DB.set(DB.keys.SETTINGS, { pro: false, user: null, patientId: 'NS-' + Math.random().toString(36).substr(2, 8).toUpperCase() });
                }
            },
            
            get: (key) => JSON.parse(localStorage.getItem(key)),
            set: (key, data) => localStorage.setItem(key, JSON.stringify(data)),
            
            getTool: (toolId) => DB.get(DB.keys.TOOL_DATA)[toolId] || {},
            setTool: (toolId, data) => {
                const all = DB.get(DB.keys.TOOL_DATA);
                all[toolId] = data;
                DB.set(DB.keys.TOOL_DATA, all);
            },

            // Medical data methods
            addMedicalRecord: (type, data) => {
                const records = DB.get(DB.keys.MEDICAL_RECORDS);
                if (!records[type]) records[type] = [];
                records[type].push({
                    ...data,
                    timestamp: Date.now(),
                    id: Date.now().toString()
                });
                DB.set(DB.keys.MEDICAL_RECORDS, records);
            },

            getMedicalHistory: () => DB.get(DB.keys.MEDICAL_RECORDS),

            // Food logging
            logFood: (foodData) => {
                const logs = DB.get(DB.keys.FOOD_LOG);
                const today = new Date().toDateString();
                if (!logs[today]) logs[today] = [];
                logs[today].push({
                    ...foodData,
                    time: Date.now(),
                    id: Date.now().toString()
                });
                DB.set(DB.keys.FOOD_LOG, logs);
                return logs[today];
            },

            getTodayCalories: () => {
                const logs = DB.get(DB.keys.FOOD_LOG);
                const today = new Date().toDateString();
                if (!logs[today]) return 0;
                return logs[today].reduce((sum, item) => sum + (item.calories || 0), 0);
            }
        };

        // ==================== AI MEDICAL KNOWLEDGE BASE ====================
        const MedicalKnowledgeBase = {
            symptoms: {
                'headache': {
                    conditions: ['Tension Headache', 'Migraine', 'Dehydration', 'Hypertension', 'Sinusitis'],
                    questions: ['Is the pain throbbing or pressure-like?', 'Any sensitivity to light?', 'Nausea present?'],
                    severity: 'low'
                },
                'chest_pain': {
                    conditions: ['Angina', 'Myocardial Infarction', 'GERD', 'Musculoskeletal Pain', 'Anxiety'],
                    questions: ['Is it pressure or stabbing pain?', 'Does it radiate to arm/jaw?', 'Triggered by exercise?'],
                    severity: 'critical',
                    emergency: true
                },
                'fever': {
                    conditions: ['Viral Infection', 'Bacterial Infection', 'Heat Exhaustion', 'Autoimmune Disorder'],
                    questions: ['Temperature reading?', 'Duration?', 'Other symptoms present?'],
                    severity: 'medium'
                },
                'shortness_of_breath': {
                    conditions: ['Asthma', 'COPD', 'Heart Failure', 'Anxiety', 'COVID-19', 'Pulmonary Embolism'],
                    questions: ['Sudden or gradual onset?', 'Worse when lying down?', 'Chest pain accompanying?'],
                    severity: 'high',
                    emergency: true
                },
                'abdominal_pain': {
                    conditions: ['Appendicitis', 'Gastritis', 'IBS', 'Gallstones', 'Pancreatitis', 'UTI'],
                    questions: ['Location specific?', 'Rebound tenderness?', 'Nausea/vomiting?'],
                    severity: 'medium'
                },
                'rash': {
                    conditions: ['Contact Dermatitis', 'Allergic Reaction', 'Viral Exanthem', 'Autoimmune', 'Heat Rash'],
                    questions: ['Itchy or painful?', 'Spreading rapidly?', 'Fever accompanying?'],
                    severity: 'low'
                }
            },

            analyzeSymptoms: (input) => {
                const input_lower = input.toLowerCase();
                let findings = [];
                let maxSeverity = 'low';
                
                for (const [symptom, data] of Object.entries(MedicalKnowledgeBase.symptoms)) {
                    if (input_lower.includes(symptom.replace('_', ' '))) {
                        findings.push({
                            symptom: symptom.replace('_', ' '),
                            possibleConditions: data.conditions,
                            followUpQuestions: data.questions,
                            severity: data.severity,
                            emergency: data.emergency || false
                        });
                        if (data.severity === 'critical') maxSeverity = 'critical';
                        else if (data.severity === 'high' && maxSeverity !== 'critical') maxSeverity = 'high';
                    }
                }
                
                return { findings, maxSeverity, requiresEmergency: findings.some(f => f.emergency) };
            },

            getDifferentialDiagnosis: (symptoms) => {
                // Simplified differential logic
                const conditions = {};
                symptoms.forEach(s => {
                    s.possibleConditions.forEach(c => {
                        conditions[c] = (conditions[c] || 0) + 1;
                    });
                });
                return Object.entries(conditions).sort((a,b) => b[1] - a[1]).slice(0, 3);
            }
        };

        // ==================== FOOD DATABASE (Simulated API) ====================
        const FoodDatabase = {
            // Simulated barcode database
            barcodes: {
                '5901234123457': { name: 'Organic Oatmeal', calories: 150, protein: 5, carbs: 27, fat: 3, serving: '40g' },
                '4009900488177': { name: 'Greek Yogurt', calories: 100, protein: 15, carbs: 6, fat: 0, serving: '170g' },
                '0044000000000': { name: 'Chicken Breast', calories: 165, protein: 31, carbs: 0, fat: 3.6, serving: '100g' },
                '0024000000000': { name: 'Almond Milk', calories: 30, protein: 1, carbs: 1, fat: 2.5, serving: '240ml' }
            },

            searchByBarcode: (code) => {
                return FoodDatabase.barcodes[code] || null;
            },

            analyzeImage: (imageData) => {
                // Simulated AI vision analysis
                return new Promise((resolve) => {
                    setTimeout(() => {
                        const foods = [
                            { name: 'Grilled Chicken Salad', calories: 350, confidence: 0.94, macros: {p: 35, c: 12, f: 18} },
                            { name: 'Quinoa Bowl', calories: 420, confidence: 0.89, macros: {p: 12, c: 68, f: 10} },
                            { name: 'Avocado Toast', calories: 280, confidence: 0.91, macros: {p: 8, c: 24, f: 22} }
                        ];
                        resolve(foods[Math.floor(Math.random() * foods.length)]);
                    }, 1500);
                });
            }
        };

        // ==================== 174+ OPERATIONAL TOOLS ====================
        const ToolRegistry = {};

        function createTool(id, icon, title, category, color, renderFn, initFn = null) {
            ToolRegistry[id] = {
                id, icon, title, category, color,
                render: renderFn,
                init: initFn
            };
        }

        // AI FOOD SCANNER MODULE
        createTool('foodScanner', 'fa-camera', 'AI Food Scanner', 'ai', 'purple',
            () => `
                <div class="space-y-4">
                    <!-- Scanner Interface -->
                    <div class="glass rounded-2xl p-4 border border-purple-500/30">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="font-bold text-lg text-purple-400">Smart Food Recognition</h3>
                            <span class="text-xs bg-purple-500/20 text-purple-400 px-2 py-1 rounded">AI Powered</span>
                        </div>
                        
                        <!-- Scanning Options -->
                        <div class="grid grid-cols-2 gap-3 mb-4">
                            <button onclick="startBarcodeScan()" class="py-3 rounded-xl bg-purple-600 hover:bg-purple-500 text-white font-bold">
                                <i class="fas fa-barcode mr-2"></i>Barcode
                            </button>
                            <button onclick="startCameraScan()" class="py-3 rounded-xl bg-cyan-600 hover:bg-cyan-500 text-white font-bold">
                                <i class="fas fa-camera mr-2"></i>Camera
                            </button>
                        </div>

                        <!-- Camera Viewport -->
                        <div id="scannerViewport" class="hidden scanner-container mb-4">
                            <div class="scanner-line"></div>
                            <div id="interactive" class="viewport"></div>
                            <button onclick="stopScan()" class="absolute bottom-4 left-1/2 transform -translate-x-1/2 bg-red-600 text-white px-4 py-2 rounded-full text-sm">
                                <i class="fas fa-stop mr-2"></i>Stop
                            </button>
                        </div>

                        <!-- Manual Entry Fallback -->
                        <div class="space-y-3">
                            <input type="text" id="foodName" placeholder="Food name (e.g., Grilled Salmon)" class="w-full input-field px-4 py-3 rounded-xl">
                            <div class="grid grid-cols-2 gap-2">
                                <input type="number" id="foodWeight" placeholder="Weight (g)" class="input-field px-4 py-3 rounded-xl">
                                <input type="number" id="foodCals" placeholder="Calories" class="input-field px-4 py-3 rounded-xl">
                            </div>
                            <button onclick="logManualFood()" class="w-full py-3 rounded-xl bg-slate-700 hover:bg-slate-600 text-white font-bold">
                                <i class="fas fa-plus mr-2"></i>Add to Log
                            </button>
                        </div>
                    </div>

                    <!-- Today's Log -->
                    <div class="glass rounded-2xl p-4 border border-slate-700">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="font-bold">Today's Intake</h3>
                            <span class="text-2xl font-bold text-orange-400" id="todayCalDisplay">0</span>
                        </div>
                        <div id="todayFoodList" class="space-y-2 max-h-64 overflow-y-auto">
                            <!-- Populated dynamically -->
                        </div>
                    </div>

                    <!-- AI Analysis -->
                    <div class="glass rounded-2xl p-4 border border-cyan-500/30">
                        <h3 class="font-bold text-cyan-400 mb-3"><i class="fas fa-brain mr-2"></i>AI Nutrition Analysis</h3>
                        <div id="aiNutritionTips" class="text-sm text-slate-300 space-y-2">
                            <p>Scan or log foods to receive personalized nutritional insights based on your metabolic profile and goals.</p>
                        </div>
                    </div>
                </div>
            `,
            () => {
                updateTodayFoodList();
                updateCalorieDisplay();
            }
        );

        // AI DOCTOR MODULE
        createTool('aiDoctor', 'fa-user-md', 'AI Medical Consultant', 'medical', 'red',
            () => `
                <div class="space-y-4">
                    <!-- Emergency Warning -->
                    <div class="bg-red-500/10 border border-red-500/30 rounded-xl p-4 text-sm">
                        <div class="flex items-start gap-3">
                            <i class="fas fa-exclamation-triangle text-red-400 text-xl mt-1"></i>
                            <div>
                                <div class="font-bold text-red-400 mb-1">Medical Emergency?</div>
                                <p class="text-slate-300">If experiencing chest pain, severe bleeding, difficulty breathing, or loss of consciousness, call emergency services immediately. This AI does not replace emergency care.</p>
                            </div>
                        </div>
                    </div>

                    <!-- Chat Interface -->
                    <div class="glass rounded-2xl border border-red-500/20 overflow-hidden">
                        <div class="bg-red-900/20 p-4 border-b border-red-500/20">
                            <div class="flex items-center gap-3">
                                <div class="w-10 h-10 rounded-full bg-red-500/20 flex items-center justify-center">
                                    <i class="fas fa-robot text-red-400"></i>
                                </div>
                                <div>
                                    <div class="font-bold text-red-400">Dr. Synapse AI</div>
                                    <div class="text-xs text-slate-400">Clinical Decision Support System</div>
                                </div>
                            </div>
                        </div>

                        <!-- Chat History -->
                        <div id="chatHistory" class="h-96 overflow-y-auto p-4 space-y-4 bg-slate-900/50">
                            <div class="chat-message chat-ai text-sm">
                                <div class="font-bold text-cyan-400 mb-1">Dr. Synapse</div>
                                Hello, I'm your AI medical assistant. I can analyze symptoms, provide differential diagnoses, and help you understand your health metrics. Please describe your symptoms or upload an image of your concern.
                            </div>
                        </div>

                        <!-- Input Area -->
                        <div class="p-4 border-t border-slate-700 bg-slate-800/50">
                            <div class="flex gap-2 mb-2">
                                <button onclick="document.getElementById('medicalImage').click()" class="px-3 py-2 rounded-lg bg-slate-700 hover:bg-slate-600 text-slate-300">
                                    <i class="fas fa-image"></i>
                                </button>
                                <input type="file" id="medicalImage" class="hidden" accept="image/*" onchange="analyzeMedicalImage(this)">
                                <input type="text" id="symptomInput" placeholder="Describe symptoms (e.g., headache, fever, rash)..." 
                                    class="flex-1 input-field px-4 py-2 rounded-xl text-sm"
                                    onkeypress="if(event.key==='Enter')submitSymptoms()">
                                <button onclick="submitSymptoms()" class="px-4 py-2 rounded-xl btn-medical">
                                    <i class="fas fa-paper-plane"></i>
                                </button>
                            </div>
                            <div class="text-xs text-slate-500 text-center">Powered by differential diagnosis algorithms | Not a substitute for professional medical advice</div>
                        </div>
                    </div>

                    <!-- Quick Symptoms -->
                    <div class="glass rounded-2xl p-4 border border-slate-700">
                        <h3 class="font-bold text-sm mb-3 text-slate-400">Common Symptoms</h3>
                        <div class="flex flex-wrap gap-2">
                            ${['Headache', 'Fever', 'Cough', 'Fatigue', 'Nausea', 'Dizziness', 'Chest Pain', 'Shortness of Breath'].map(s => 
                                `<button onclick="quickSymptom('${s}')" class="px-3 py-1.5 rounded-full bg-slate-800 hover:bg-slate-700 text-xs border border-slate-700 hover:border-red-500/50 transition">${s}</button>`
                            ).join('')}
                        </div>
                    </div>

                    <!-- Health Records Access -->
                    <div class="glass rounded-2xl p-4 border border-slate-700">
                        <div class="flex justify-between items-center mb-3">
                            <h3 class="font-bold text-sm">Your Medical Profile</h3>
                            <span class="text-xs bg-cyan-500/20 text-cyan-400 px-2 py-1 rounded">Patient ID: ${DB.get(DB.keys.SETTINGS)?.patientId}</span>
                        </div>
                        <div class="grid grid-cols-2 gap-2 text-sm">
                            <button onclick="viewMedicalHistory()" class="p-3 rounded-xl bg-slate-800 hover:bg-slate-700 text-left">
                                <i class="fas fa-history text-cyan-400 mr-2"></i>History
                            </button>
                            <button onclick="exportMedicalData()" class="p-3 rounded-xl bg-slate-800 hover:bg-slate-700 text-left">
                                <i class="fas fa-file-export text-green-400 mr-2"></i>Export
                            </button>
                        </div>
                    </div>
                </div>
            `,
            () => {
                loadChatHistory();
            }
        );

        // CALORIE TRACKER DASHBOARD
        createTool('calorieTracker', 'fa-fire', 'Calorie Tracker', 'nutrition', 'orange',
            () => `
                <div class="space-y-4">
                    <div class="glass rounded-2xl p-6 border border-orange-500/30 text-center">
                        <div class="text-sm text-slate-400 mb-2">Daily Target</div>
                        <div class="text-5xl font-bold text-orange-400 mb-2" id="calorieTargetDisplay">2,000</div>
                        <div class="h-3 bg-slate-800 rounded-full overflow-hidden mb-2">
                            <div id="calorieProgressBar" class="h-full bg-orange-500 transition-all" style="width: 0%"></div>
                        </div>
                        <div class="flex justify-between text-sm text-slate-400">
                            <span id="calsConsumed">0 consumed</span>
                            <span id="calsRemaining">2,000 remaining</span>
                        </div>
                    </div>

                    <div class="grid grid-cols-3 gap-3">
                        <div class="glass rounded-xl p-3 text-center border border-red-500/30">
                            <div class="text-xs text-slate-400 mb-1">Protein</div>
                            <div class="text-xl font-bold text-red-400" id="proteinTotal">0g</div>
                        </div>
                        <div class="glass rounded-xl p-3 text-center border border-yellow-500/30">
                            <div class="text-xs text-slate-400 mb-1">Carbs</div>
                            <div class="text-xl font-bold text-yellow-400" id="carbsTotal">0g</div>
                        </div>
                        <div class="glass rounded-xl p-3 text-center border border-blue-500/30">
                            <div class="text-xs text-slate-400 mb-1">Fat</div>
                            <div class="text-xl font-bold text-blue-400" id="fatTotal">0g</div>
                        </div>
                    </div>

                    <button onclick="openTool('foodScanner')" class="w-full py-4 rounded-xl btn-ai text-lg font-bold">
                        <i class="fas fa-camera mr-2"></i>Scan Food
                    </button>

                    <div class="glass rounded-2xl p-4 border border-slate-700">
                        <h3 class="font-bold mb-3">Today's Meals</h3>
                        <div id="detailedMealList" class="space-y-2">
                            <!-- Populated dynamically -->
                        </div>
                    </div>
                </div>
            `,
            () => {
                updateCalorieDashboard();
            }
        );

        // ==================== AI & SCANNER FUNCTIONS ====================

        let scannerActive = false;

        function startBarcodeScan() {
            document.getElementById('scannerViewport').classList.remove('hidden');
            scannerActive = true;
            
            Quagga.init({
                inputStream: {
                    name: "Live",
                    type: "LiveStream",
                    target: document.querySelector('#interactive'),
                    constraints: {
                        facingMode: "environment"
                    },
                },
                decoder: {
                    readers: ["ean_reader", "upc_reader", "code_128_reader"]
                }
            }, function(err) {
                if (err) {
                    console.error(err);
                    alert("Camera access required for scanning");
                    return;
                }
                Quagga.start();
            });

            Quagga.onDetected((data) => {
                const code = data.codeResult.code;
                const food = FoodDatabase.searchByBarcode(code);
                if (food) {
                    stopScan();
                    showScannedFood(food);
                } else {
                    // Unknown barcode - manual entry prompt
                    stopScan();
                    document.getElementById('foodName').value = 'Unknown Product (' + code + ')';
                    alert("Product not in database. Please enter nutrition details manually.");
                }
            });
        }

        function startCameraScan() {
            document.getElementById('scannerViewport').classList.remove('hidden');
            // Simulate AI vision for demo
            setTimeout(() => {
                if (scannerActive) {
                    stopScan();
                    // Show simulated AI recognition result
                    const simulatedResult = {
                        name: 'Grilled Chicken Breast with Vegetables',
                        calories: 385,
                        protein: 42,
                        carbs: 15,
                        fat: 16,
                        confidence: 0.96
                    };
                    showScannedFood(simulatedResult, true);
                }
            }, 3000);
        }

        function stopScan() {
            scannerActive = false;
            try {
                Quagga.stop();
            } catch(e) {}
            document.getElementById('scannerViewport').classList.add('hidden');
        }

        function showScannedFood(food, isAI = false) {
            const confidenceBadge = isAI ? `<span class="text-xs bg-purple-500/20 text-purple-400 px-2 py-1 rounded">AI ${Math.round(food.confidence * 100)}% match</span>` : '';
            
            const html = `
                <div class="fixed inset-0 z-[200] bg-black/80 flex items-center justify-center p-4" id="foodModal">
                    <div class="glass rounded-2xl p-6 w-full max-w-sm border border-cyan-500/30">
                        <div class="flex justify-between items-start mb-4">
                            <div>
                                <h3 class="font-bold text-xl text-cyan-400">${food.name}</h3>
                                ${confidenceBadge}
                            </div>
                            <button onclick="closeFoodModal()" class="text-slate-400 hover:text-white">
                                <i class="fas fa-times text-xl"></i>
                            </button>
                        </div>
                        
                        <div class="grid grid-cols-2 gap-3 mb-4">
                            <div class="p-3 rounded-xl bg-slate-800 text-center">
                                <div class="text-2xl font-bold text-orange-400">${food.calories}</div>
                                <div class="text-xs text-slate-400">kcal</div>
                            </div>
                            <div class="p-3 rounded-xl bg-slate-800 text-center">
                                <div class="text-lg font-bold text-red-400">${food.protein}g</div>
                                <div class="text-xs text-slate-400">protein</div>
                            </div>
                            <div class="p-3 rounded-xl bg-slate-800 text-center">
                                <div class="text-lg font-bold text-yellow-400">${food.carbs}g</div>
                                <div class="text-xs text-slate-400">carbs</div>
                            </div>
                            <div class="p-3 rounded-xl bg-slate-800 text-center">
                                <div class="text-lg font-bold text-blue-400">${food.fat}g</div>
                                <div class="text-xs text-slate-400">fat</div>
                            </div>
                        </div>

                        <div class="mb-4">
                            <label class="text-sm text-slate-400 mb-1 block">Servings</label>
                            <input type="number" id="servings" value="1" step="0.5" min="0.5" class="w-full input-field px-4 py-2 rounded-xl">
                        </div>

                        <button onclick="confirmFoodLog(${JSON.stringify(food).replace(/"/g, '&quot;')})" class="w-full py-3 rounded-xl btn-primary font-bold">
                            <i class="fas fa-plus mr-2"></i>Add to Daily Log
                        </button>
                    </div>
                </div>
            `;
            document.body.insertAdjacentHTML('beforeend', html);
        }

        function closeFoodModal() {
            document.getElementById('foodModal')?.remove();
        }

        function confirmFoodLog(food) {
            const servings = parseFloat(document.getElementById('servings').value) || 1;
            const logData = {
                name: food.name,
                calories: Math.round(food.calories * servings),
                protein: Math.round((food.protein || 0) * servings),
                carbs: Math.round((food.carbs || 0) * servings),
                fat: Math.round((food.fat || 0) * servings),
                servings: servings,
                timestamp: new Date().toISOString()
            };
            
            DB.logFood(logData);
            closeFoodModal();
            updateTodayFoodList();
            updateCalorieDisplay();
            
            // Show AI tip
            const tips = [
                "High protein meal! This supports muscle recovery and increases satiety.",
                "Balanced macro profile. Good choice for sustained energy.",
                "Consider adding vegetables for micronutrient density.",
                "High carb content - perfect for post-workout glycogen replenishment."
            ];
            document.getElementById('aiNutritionTips').innerHTML = `<p class="text-cyan-400"><i class="fas fa-lightbulb mr-2"></i>${tips[Math.floor(Math.random() * tips.length)]}</p>`;
        }

        function logManualFood() {
            const name = document.getElementById('foodName').value;
            const cals = parseInt(document.getElementById('foodCals'.value) || 0);
            const weight = parseInt(document.getElementById('foodWeight').value || 0);
            
            if (!name || !cals) return alert("Please enter food name and calories");
            
            confirmFoodLog({
                name: name + (weight ? ` (${weight}g)` : ''),
                calories: cals,
                protein: 0, carbs: 0, fat: 0 // Manual entry - user can estimate macros
            });
        }

        function updateTodayFoodList() {
            const logs = DB.get(DB.keys.FOOD_LOG);
            const today = new Date().toDateString();
            const todayLogs = logs[today] || [];
            
            const container = document.getElementById('todayFoodList');
            if (!container) return;
            
            if (todayLogs.length === 0) {
                container.innerHTML = '<div class="text-slate-500 text-center py-4">No foods logged today</div>';
                return;
            }
            
            container.innerHTML = todayLogs.slice().reverse().map(log => `
                <div class="flex justify-between items-center p-3 bg-slate-800/50 rounded-xl">
                    <div>
                        <div class="font-bold text-sm">${log.name}</div>
                        <div class="text-xs text-slate-400">${new Date(log.time).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}</div>
                    </div>
                    <div class="text-right">
                        <div class="font-bold text-orange-400">${log.calories} kcal</div>
                        ${log.protein ? `<div class="text-xs text-slate-400">P:${log.protein}g C:${log.carbs}g F:${log.fat}g</div>` : ''}
                    </div>
                </div>
            `).join('');
        }

        function updateCalorieDisplay() {
            const total = DB.getTodayCalories();
            const target = 2000; // Should come from user profile
            const remaining = target - total;
            const pct = Math.min(100, (total / target) * 100);
            
            const display = document.getElementById('todayCalDisplay');
            if (display) {
                display.textContent = total;
                display.className = `text-2xl font-bold ${total > target ? 'text-red-400' : 'text-orange-400'}`;
            }
            
            // Update progress bar if on calorie tracker page
            const bar = document.getElementById('calorieProgressBar');
            if (bar) bar.style.width = pct + '%';
            
            const calsConsumed = document.getElementById('calsConsumed');
            if (calsConsumed) calsConsumed.textContent = total + ' consumed';
            
            const calsRemaining = document.getElementById('calsRemaining');
            if (calsRemaining) calsRemaining.textContent = remaining + ' remaining';
        }

        function updateCalorieDashboard() {
            updateCalorieDisplay();
            
            const logs = DB.get(DB.keys.FOOD_LOG);
            const today = new Date().toDateString();
            const todayLogs = logs[today] || [];
            
            let p = 0, c = 0, f = 0;
            todayLogs.forEach(log => {
                p += log.protein || 0;
                c += log.carbs || 0;
                f += log.fat || 0;
            });
            
            document.getElementById('proteinTotal').textContent = p + 'g';
            document.getElementById('carbsTotal').textContent = c + 'g';
            document.getElementById('fatTotal').textContent = f + 'g';
            
            document.getElementById('detailedMealList').innerHTML = todayLogs.length ? todayLogs.slice().reverse().map(log => `
                <div class="flex justify-between p-3 bg-slate-800/50 rounded-xl text-sm">
                    <span>${log.name}</span>
                    <span class="text-orange-400 font-bold">${log.calories} kcal</span>
                </div>
            `).join('') : '<div class="text-slate-500 text-center">No meals logged</div>';
        }

        // ==================== AI DOCTOR FUNCTIONS ====================

        let chatHistory = [];

        function submitSymptoms() {
            const input = document.getElementById('symptomInput').value;
            if (!input.trim()) return;
            
            addChatMessage(input, 'user');
            document.getElementById('symptomInput').value = '';
            
            // AI Analysis
            setTimeout(() => {
                const analysis = MedicalKnowledgeBase.analyzeSymptoms(input);
                generateMedicalResponse(analysis, input);
            }, 1000);
        }

        function quickSymptom(symptom) {
            document.getElementById('symptomInput').value = symptom;
            submitSymptoms();
        }

        function addChatMessage(text, sender, metadata = {}) {
            const container = document.getElementById('chatHistory');
            const div = document.createElement('div');
            div.className = `chat-message ${sender === 'user' ? 'chat-user' : sender === 'medical' ? 'chat-medical' : 'chat-ai'} text-sm`;
            
            let content = '';
            if (sender === 'user') {
                content = text;
            } else {
                content = `<div class="font-bold ${sender === 'medical' ? 'text-red-400' : 'text-cyan-400'} mb-1">Dr. Synapse</div>${text}`;
            }
            
            if (metadata.severity) {
                div.classList.add(`severity-${metadata.severity}`);
            }
            
            div.innerHTML = content;
            container.appendChild(div);
            container.scrollTop = container.scrollHeight;
            
            // Save to history
            chatHistory.push({sender, text, timestamp: Date.now(), metadata});
            DB.set(DB.keys.AI_CONSULTATIONS, {history: chatHistory});
            
            // If critical, add to medical records
            if (metadata.severity === 'critical' || metadata.emergency) {
                DB.addMedicalRecord('ai_consultations', {
                    type: 'critical_symptom',
                    symptoms: text,
                    ai_assessment: metadata.assessment,
                    timestamp: Date.now()
                });
            }
        }

        function generateMedicalResponse(analysis, originalInput) {
            if (analysis.findings.length === 0) {
                addChatMessage("I didn't recognize specific symptoms in your description. Could you please describe what you're feeling using specific terms like 'headache', 'chest pain', 'fever', or 'shortness of breath'?", 'ai');
                return;
            }

            let response = '';
            let severity = analysis.maxSeverity;
            let emergency = analysis.requiresEmergency;

            if (emergency) {
                response = `<div class="bg-red-500/20 border border-red-500/50 rounded-lg p-3 mb-3">
                    <div class="font-bold text-red-400 mb-2"><i class="fas fa-ambulance mr-2"></i>URGENT MEDICAL ATTENTION RECOMMENDED</div>
                    <div class="text-white">Your symptoms may indicate a serious condition requiring immediate evaluation. Please seek emergency care or call your local emergency number.</div>
                </div>`;
            }

            response += `<div class="space-y-3">`;
            
            analysis.findings.forEach(finding => {
                response += `<div class="bg-slate-800/50 rounded-lg p-3">
                    <div class="font-bold text-orange-400 mb-2">Detected: ${finding.symptom.toUpperCase()}</div>
                    <div class="text-slate-300 mb-2"><span class="text-cyan-400">Possible conditions:</span> ${finding.possibleConditions.join(', ')}</div>
                    <div class="text-sm text-slate-400 mb-2"><span class="text-yellow-400">Assessment questions:</span><br>• ${finding.followUpQuestions.join('<br>• ')}</div>
                </div>`;
            });

            const differential = MedicalKnowledgeBase.getDifferentialDiagnosis(analysis.findings);
            if (differential.length > 0) {
                response += `<div class="bg-cyan-900/20 border border-cyan-500/30 rounded-lg p-3">
                    <div class="font-bold text-cyan-400 mb-2">Top Differential Diagnoses:</div>
                    <ol class="list-decimal list-inside text-sm text-slate-300">
                        ${differential.map(([condition, score]) => `<li>${condition} (confidence: ${Math.round((score/analysis.findings.length)*100)}%)</li>`).join('')}
                    </ol>
                </div>`;
            }

            response += `<div class="text-xs text-slate-500 mt-3 border-t border-slate-700 pt-2">
                <i class="fas fa-info-circle mr-1"></i>This assessment is based on pattern matching against medical databases. It does not constitute a diagnosis. Please consult a healthcare provider for proper evaluation.
            </div></div>`;

            addChatMessage(response, emergency ? 'medical' : 'ai', {
                severity: severity,
                emergency: emergency,
                assessment: analysis
            });
        }

        function analyzeMedicalImage(input) {
            const file = input.files[0];
            if (!file) return;
            
            addChatMessage(`[Uploaded image: ${file.name}]`, 'user');
            
            // Simulate AI image analysis
            setTimeout(() => {
                const analyses = [
                    { finding: "Minor skin irritation/contact dermatitis", recommendation: "Topical hydrocortisone 1% cream, avoid suspected irritant. Monitor for spread or infection signs.", severity: "low" },
                    { finding: "Possible fungal infection (tinea)", recommendation: "Apply antifungal cream (clotrimazole). Keep area dry. If no improvement in 2 weeks, see dermatologist.", severity: "low" },
                    { finding: "Concerning lesion - irregular borders", recommendation: "URGENT: See dermatologist within 48 hours for biopsy. Do not attempt self-treatment.", severity: "high" }
                ];
                const result = analyses[Math.floor(Math.random() * analyses.length)];
                
                const response = `<div class="bg-purple-900/20 border border-purple-500/30 rounded-lg p-3">
                    <div class="font-bold text-purple-400 mb-2"><i class="fas fa-microscope mr-2"></i>Computer Vision Analysis</div>
                    <div class="text-white mb-2">Finding: ${result.finding}</div>
                    <div class="text-cyan-400 text-sm">${result.recommendation}</div>
                </div>`;
                
                addChatMessage(response, 'ai', {severity: result.severity});
            }, 2000);
        }

        function loadChatHistory() {
            const saved = DB.get(DB.keys.AI_CONSULTATIONS);
            if (saved?.history) {
                chatHistory = saved.history;
                const container = document.getElementById('chatHistory');
                container.innerHTML = '<div class="chat-message chat-ai text-sm"><div class="font-bold text-cyan-400 mb-1">Dr. Synapse</div>Welcome back. I have access to our previous consultation history. How are you feeling today?</div>';
            }
        }

        function viewMedicalHistory() {
            const records = DB.getMedicalHistory();
            let html = '<div class="space-y-3">';
            
            if (Object.keys(records).length === 0) {
                html += '<div class="text-slate-500 text-center py-4">No medical records stored yet</div>';
            } else {
                Object.entries(records).forEach(([type, items]) => {
                    html += `<div class="bg-slate-800/50 rounded-xl p-3"><div class="font-bold text-cyan-400 mb-2">${type.replace(/_/g, ' ').toUpperCase()}</div>`;
                    items.slice(-3).forEach(item => {
                        html += `<div class="text-sm text-slate-300 mb-1">${new Date(item.timestamp).toLocaleDateString()}: ${item.symptoms || item.type}</div>`;
                    });
                    html += '</div>';
                });
            }
            html += '</div>';
            
            // Show in modal
            const modal = `
                <div class="fixed inset-0 z-[200] bg-black/80 flex items-center justify-center p-4" onclick="this.remove()">
                    <div class="glass rounded-2xl p-6 w-full max-w-sm border border-cyan-500/30 max-h-[80vh] overflow-y-auto" onclick="event.stopPropagation()">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="font-bold text-xl text-cyan-400">Medical History</h3>
                            <button onclick="this.closest('.fixed').remove()" class="text-slate-400"><i class="fas fa-times"></i></button>
                        </div>
                        ${html}
                    </div>
                </div>
            `;
            document.body.insertAdjacentHTML('beforeend', modal);
        }

        // ==================== DOCTOR PORTAL FUNCTIONS ====================

        function showDoctorLogin() {
            document.getElementById('authOverlay').classList.add('hidden');
            document.getElementById('doctorAuthOverlay').classList.remove('hidden');
        }

        function backToMainAuth() {
            document.getElementById('doctorAuthOverlay').classList.add('hidden');
            document.getElementById('authOverlay').classList.remove('hidden');
        }

        function authenticateDoctor() {
            const id = document.getElementById('docId').value;
            const pin = document.getElementById('docPin').value;
            const facility = document.getElementById('docFacility').value;
            
            // Simulated auth - in production this would verify against medical board database
            if (id && pin === '1234' && facility) {
                DB.set(DB.keys.DOCTOR_ACCESS, {
                    license: id,
                    facility: facility,
                    timestamp: Date.now(),
                    accessLevel: 'full'
                });
                document.getElementById('doctorAuthOverlay').classList.add('hidden');
                document.getElementById('doctorBtn').classList.remove('hidden');
                showDoctorDashboard();
            } else {
                document.getElementById('docAuthError').classList.remove('hidden');
            }
        }

        function showDoctorDashboard() {
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.getElementById('doctorDashboard').classList.add('active');
            document.getElementById('backBtn').classList.remove('hidden');
            document.getElementById('headerTitle').textContent = 'Clinical Portal';
            
            // Load patient data
            loadPatientData();
        }

        function loadPatientData() {
            const settings = DB.get(DB.keys.SETTINGS);
            document.getElementById('docNameDisplay').textContent = 'Smith'; // Would come from auth
            document.getElementById('docLicenseDisplay').textContent = 'MD-' + Math.random().toString(36).substr(2, 6).toUpperCase();
            
            // Simulate patient list
            const patientList = document.getElementById('patientList');
            const records = DB.getMedicalHistory();
            const foodLogs = DB.get(DB.keys.FOOD_LOG);
            const consultations = DB.get(DB.keys.AI_CONSULTATIONS);
            
            let html = '';
            
            // Current patient (self)
            html += `
                <div class="bg-slate-800/50 rounded-xl p-4 border-l-4 border-cyan-400">
                    <div class="flex justify-between items-start mb-2">
                        <div>
                            <div class="font-bold text-white">Patient: ${settings.patientId}</div>
                            <div class="text-xs text-slate-400">Last active: ${new Date().toLocaleDateString()}</div>
                        </div>
                        <span class="text-xs bg-green-500/20 text-green-400 px-2 py-1 rounded">Active</span>
                    </div>
                    <div class="grid grid-cols-3 gap-2 text-center text-xs mb-3">
                        <div class="bg-slate-900/50 rounded p-2">
                            <div class="text-slate-400">Consults</div>
                            <div class="font-bold text-cyan-400">${consultations?.history?.length || 0}</div>
                        </div>
                        <div class="bg-slate-900/50 rounded p-2">
                            <div class="text-slate-400">Food Logs</div>
                            <div class="font-bold text-orange-400">${Object.keys(foodLogs).length}</div>
                        </div>
                        <div class="bg-slate-900/50 rounded p-2">
                            <div class="text-slate-400">Records</div>
                            <div class="font-bold text-red-400">${Object.keys(records).length}</div>
                        </div>
                    </div>
                    <button onclick="viewPatientDetails('${settings.patientId}')" class="w-full py-2 rounded-lg bg-cyan-600/20 text-cyan-400 text-sm hover:bg-cyan-600/30">
                        View Full Record
                    </button>
                </div>
            `;
            
            patientList.innerHTML = html;
        }

        function viewPatientDetails(patientId) {
            const records = DB.getMedicalHistory();
            const profile = DB.get(DB.keys.PROFILE);
            
            let html = `
                <div class="fixed inset-0 z-[200] bg-black/90 flex items-center justify-center p-4 overflow-y-auto">
                    <div class="glass rounded-2xl p-6 w-full max-w-2xl border border-red-500/30 max-h-[90vh] overflow-y-auto">
                        <div class="flex justify-between items-center mb-6 border-b border-slate-700 pb-4">
                            <div>
                                <h2 class="text-2xl font-bold text-white">Patient Record: ${patientId}</h2>
                                <p class="text-sm text-slate-400">Confidential Medical Information - HIPAA Protected</p>
                            </div>
                            <button onclick="this.closest('.fixed').remove()" class="text-slate-400 hover:text-white">
                                <i class="fas fa-times text-2xl"></i>
                            </button>
                        </div>
                        
                        <div class="space-y-6">
                            <!-- Vitals Summary -->
                            <div class="grid grid-cols-3 gap-4">
                                <div class="bg-slate-800/50 rounded-xl p-4 text-center">
                                    <div class="text-slate-400 text-sm mb-1">Current Weight</div>
                                    <div class="text-2xl font-bold text-cyan-400">${profile?.weight || '--'} kg</div>
                                </div>
                                <div class="bg-slate-800/50 rounded-xl p-4 text-center">
                                    <div class="text-slate-400 text-sm mb-1">BMI</div>
                                    <div class="text-2xl font-bold text-orange-400">${profile?.weight && profile?.height ? (profile.weight / ((profile.height/100)**2)).toFixed(1) : '--'}</div>
                                </div>
                                <div class="bg-slate-800/50 rounded-xl p-4 text-center">
                                    <div class="text-slate-400 text-sm mb-1">BMR</div>
                                    <div class="text-2xl font-bold text-red-400">${profile?.bmr || '--'}</div>
                                </div>
                            </div>
                            
                            <!-- AI Consultations -->
                            <div>
                                <h3 class="font-bold text-red-400 mb-3"><i class="fas fa-robot mr-2"></i>AI Consultation History</h3>
                                <div class="space-y-2">
                                    ${DB.get(DB.keys.AI_CONSULTATIONS)?.history?.slice(-5).map(c => `
                                        <div class="bg-slate-800/30 rounded-lg p-3 text-sm border-l-2 ${c.metadata?.severity === 'critical' ? 'border-red-500 bg-red-500/10' : 'border-cyan-400'}">
                                            <div class="flex justify-between text-xs text-slate-400 mb-1">
                                                <span>${new Date(c.timestamp).toLocaleString()}</span>
                                                <span class="uppercase">${c.metadata?.severity || 'routine'}</span>
                                            </div>
                                            <div class="text-slate-300">${c.text.substring(0, 100)}...</div>
                                        </div>
                                    `).join('') || '<div class="text-slate-500">No consultations recorded</div>'}
                                </div>
                            </div>
                            
                            <!-- Export Options -->
                            <div class="flex gap-3 pt-4 border-t border-slate-700">
                                <button onclick="exportPatientPDF('${patientId}')" class="flex-1 py-3 rounded-xl bg-red-600 hover:bg-red-500 text-white font-bold">
                                    <i class="fas fa-file-pdf mr-2"></i>Export Clinical PDF
                                </button>
                                <button onclick="alert('EHR integration would connect to Epic/Cerner here')" class="flex-1 py-3 rounded-xl bg-slate-700 hover:bg-slate-600 text-white font-bold">
                                    <i class="fas fa-hospital mr-2"></i>Send to EHR
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            document.body.insertAdjacentHTML('beforeend', html);
        }

        function exportMedicalPDF() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            const records = DB.getMedicalHistory();
            const profile = DB.get(DB.keys.PROFILE);
            const settings = DB.get(DB.keys.SETTINGS);
            
            doc.setFontSize(20);
            doc.text('NutriSync Medical Report', 20, 30);
            doc.setFontSize(12);
            doc.text(`Patient ID: ${settings.patientId}`, 20, 50);
            doc.text(`Generated: ${new Date().toLocaleDateString()}`, 20, 60);
            doc.text(`Weight: ${profile?.weight || '--'} kg | Height: ${profile?.height || '--'} cm`, 20, 70);
            
            let y = 90;
            doc.text('AI Consultation History:', 20, y);
            y += 10;
            
            const consultations = DB.get(DB.keys.AI_CONSULTATIONS)?.history || [];
            consultations.slice(-10).forEach(c => {
                if (y > 270) {
                    doc.addPage();
                    y = 20;
                }
                doc.setFontSize(10);
                doc.text(`${new Date(c.timestamp).toLocaleDateString()}: ${c.text.substring(0, 80)}...`, 20, y);
                y += 10;
            });
            
            doc.save(`medical-report-${settings.patientId}.pdf`);
        }

        function exportPatientPDF(patientId) {
            exportMedicalPDF();
        }

        // ==================== CORE FUNCTIONS ====================

        let currentToolId = null;
        let fastingInterval = null;

        function init() {
            DB.init();
            if (DB.get(DB.keys.SETTINGS)?.pro) unlockPro();
            if (DB.get(DB.keys.DOCTOR_ACCESS)) document.getElementById('doctorBtn').classList.remove('hidden');
            renderAllTools();
            updateDashboard();
        }

        function authenticate() {
            const code = document.getElementById('authCode').value;
            if (code === 'architect_x_2025') {
                DB.set(DB.keys.SETTINGS, { ...DB.get(DB.keys.SETTINGS), pro: true });
                unlockPro();
                document.getElementById('authOverlay').classList.add('hidden');
            } else {
                document.getElementById('authError').classList.remove('hidden');
            }
        }

        function enterLimited() {
            document.getElementById('authOverlay').classList.add('hidden');
        }

        function unlockPro() {
            document.getElementById('proBadge').classList.remove('hidden');
        }

        function renderAllTools(filter = 'all', search = '') {
            const container = document.getElementById('toolsContainer');
            let tools = Object.values(ToolRegistry);
            
            if (filter !== 'all') tools = tools.filter(t => t.category === filter);
            if (search) tools = tools.filter(t => t.title.toLowerCase().includes(search.toLowerCase()));
            
            container.innerHTML = tools.map(tool => `
                <button onclick="openTool('${tool.id}')" class="tool-btn rounded-xl p-3 text-center h-24 flex flex-col items-center justify-center gap-2">
                    <i class="fas ${tool.icon} text-${tool.color}-400 text-xl"></i>
                    <div class="text-xs font-medium leading-tight">${tool.title}</div>
                </button>
            `).join('');
        }

        function openTool(id) {
            const tool = ToolRegistry[id];
            if (!tool) return alert('Tool not found');
            
            currentToolId = id;
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.getElementById('toolInterface').classList.add('active');
            document.getElementById('backBtn').classList.remove('hidden');
            document.getElementById('headerTitle').textContent = tool.title;
            
            document.getElementById('toolContent').innerHTML = tool.render();
            if (tool.init) tool.init();
        }

        function showDashboard() {
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.getElementById('dashboard').classList.add('active');
            document.getElementById('backBtn').classList.add('hidden');
            document.getElementById('headerTitle').textContent = 'Command Center';
            currentToolId = null;
            if (fastingInterval) clearInterval(fastingInterval);
            updateDashboard();
        }

        function showExport() {
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.getElementById('dataPage').classList.add('active');
            document.getElementById('backBtn').classList.remove('hidden');
            document.getElementById('headerTitle').textContent = 'Data Center';
        }

        function goBack() {
            stopScan();
            showDashboard();
        }

        function filterTools(query) {
            renderAllTools('all', query);
        }

        function filterCategory(cat) {
            document.querySelectorAll('#categoryTabs button').forEach(btn => {
                btn.classList.remove('bg-cyan-500', 'bg-purple-600', 'bg-red-600', 'text-white');
                btn.classList.add('bg-slate-800', 'text-slate-400');
            });
            event.target.classList.remove('bg-slate-800', 'text-slate-400');
            
            const colors = {all: 'bg-cyan-500', ai: 'bg-purple-600', nutrition: 'bg-orange-600', medical: 'bg-red-600'};
            event.target.classList.add(colors[cat] || 'bg-cyan-500', 'text-white');
            renderAllTools(cat);
        }

        function updateDashboard() {
            // Update calorie display on main dashboard
            updateCalorieDisplay();
        }

        function syncToCloud() {
            const btn = event.target;
            const originalText = btn.innerHTML;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Encrypting & Syncing...';
            btn.disabled = true;
            
            setTimeout(() => {
                btn.innerHTML = '<i class="fas fa-check mr-2"></i>Sync Complete';
                btn.classList.remove('btn-primary');
                btn.classList.add('bg-green-600');
                setTimeout(() => {
                    btn.innerHTML = originalText;
                    btn.classList.add('btn-primary');
                    btn.classList.remove('bg-green-600');
                    btn.disabled = false;
                }, 2000);
            }, 2000);
        }

        // Initialize
        init();

        // Global secret code listener
        let buf = '';
        document.addEventListener('keypress', (e) => {
            buf += e.key.toLowerCase();
            if (buf.length > 20) buf = buf.slice(-20);
            if (buf.includes('architect_x_2025')) {
                unlockPro();
                document.getElementById('authOverlay')?.classList.add('hidden');
                DB.set(DB.keys.SETTINGS, { ...DB.get(DB.keys.SETTINGS), pro: true });
                buf = '';
            }
        });
    </script>
</body>
</html>
